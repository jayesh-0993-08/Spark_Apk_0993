<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>spark - Integrated Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #0f1020;
            --card: #0b1220;
            --accent1: #6EE7B7;
            --accent2: #7C4DFF;
            --neon: #00FFE1;
            --glass: rgba(255, 255, 255, 0.04);
            --muted: #bfc7d6;
            --radius: 14px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .camera-container {
            position: relative;
            width: 100%;
            padding-bottom: 60%;
        }

        video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.5rem;
            background-color: black;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        .attendance-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Neon Rescheduler Styles */
        .panel {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border: 1px solid rgba(124, 77, 255, 0.09);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.6), 0 0 30px rgba(124, 77, 255, 0.04) inset;
        }

        .input,
        select,
        textarea {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.06);
            padding: 10px 12px;
            border-radius: 10px;
            color: #eaf6ff;
            outline: none;
        }

        .btn {
            background: linear-gradient(90deg, var(--accent2), var(--accent1));
            border: none;
            color: #041024;
            padding: 10px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(124, 77, 255, 0.18);
        }

        .subject-chip {
            background: linear-gradient(90deg, rgba(124, 77, 255, 0.12), rgba(110, 231, 183, 0.06));
            border-radius: 10px;
            padding: 8px;
            min-width: 260px;
            border: 1px solid rgba(255, 255, 255, 0.03);
            color: var(--neon);
            font-size: 13px;
        }

        table.grid {
            width: 100%;
            border-collapse: collapse;
        }

        table.grid th,
        table.grid td {
            border: 1px solid rgba(255, 255, 255, 0.04);
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }

        .badge {
            padding: 6px 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, #00ffe1, #7c4dff);
            color: #041018;
            font-weight: 700;
            font-size: 13px;
            box-shadow: 0 8px 18px rgba(124, 77, 255, 0.08);
        }
    </style>

    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>

    </script>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // 1. PASTE YOUR NEW API KEY HERE

        const API_KEY = "Enter your API key";


        try {
            const genAI = new GoogleGenerativeAI(API_KEY);

            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            ({
                systemInstruction: "You are a helpful assistant for the SmartClass student portal. Keep answers concise."
            });
            const chat = model.startChat({ history: [] });

            window.geminiAI = {
                sendMessage: async function (userMessage, onChunk) {
                    const result = await chat.sendMessageStream(userMessage);
                    for await (const chunk of result.stream) {
                        onChunk(chunk.text());
                    }
                }
            };
            console.log("✅ AI System Initialized");
        } catch (e) {
            console.error("AI Init Error:", e);
        }
    </script>

    <style>
        /* Gemini Chat Widget Styles */
        .gemini-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            max-height: 500px;
            background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px rgba(79, 172, 254, 0.1);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            overflow: hidden;
            z-index: 9999;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .gemini-chat-header h3 {
            margin: 0;
            color: #0a0a1a;
            font-size: 16px;
            font-weight: 600;
        }

        .gemini-chat-header .gemini-icon {
            width: 28px;
            height: 28px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-chat-messages {
            height: 320px;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .gemini-message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .gemini-message.user {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #0a0a1a;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .gemini-message.assistant {
            background: rgba(255, 255, 255, 0.08);
            color: #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gemini-chat-input-container {
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .gemini-chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .gemini-chat-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.2);
        }

        .gemini-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .gemini-send-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 10px;
            color: #0a0a1a;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .gemini-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.4);
        }

        .gemini-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .gemini-typing {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .gemini-typing span {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .gemini-typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .gemini-typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .gemini-toggle-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(79, 172, 254, 0.4);
            z-index: 9998;
            transition: transform 0.3s, box-shadow 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gemini-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(79, 172, 254, 0.5);
        }

        .gemini-toggle-btn svg {
            width: 28px;
            height: 28px;
            fill: #0a0a1a;
        }
    </style>
</head>

<body class="bg-gray-900 min-h-screen text-white">

    <!-- LANDING PAGE / AUTH SCREENS (Full Screen - Moved Outside Main App) -->
    <div id="auth-screens" class="min-h-screen flex flex-col justify-center items-center p-4">
        <!-- Role Selection Screen -->
        <div id="role-selection" class="flex flex-col items-center justify-center w-full max-w-6xl fade-in">
            <div class="text-center mb-16">
                <!-- Logo/Icon -->
                <div class="inline-flex items-center justify-center w-24 h-24 rounded-3xl bg-blue-600/10 mb-8">
                    <i class="fas fa-graduation-cap text-6xl text-blue-500"></i>
                </div>
                <h1 class="text-5xl md:text-6xl font-bold text-white mb-6 tracking-tight">Welcome to SPARK</h1>
                <p class="text-gray-400 text-xl max-w-2xl mx-auto">Your comprehensive platform for modern education
                    management. Select your role to get started.</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full px-4">
                <!-- Student Card -->
                <div class="bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-blue-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-blue-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="enterStudentPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-blue-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-user-graduate text-4xl text-blue-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Student</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">Access your attendance, manage
                        your timetable, and receive personalized learning suggestions.</p>
                    <button
                        class="w-full py-4 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-blue-500/25">
                        Login as Student
                    </button>
                </div>

                <!-- Teacher Card -->
                <div class="bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-green-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-green-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="enterTeacherPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-green-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-chalkboard-teacher text-4xl text-green-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Teacher</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">Mark class attendance, update
                        scheduling, and manage academic resources.</p>
                    <button
                        class="w-full py-4 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-green-500/25">
                        Login as Teacher
                    </button>
                </div>

                <!-- Admin Card -->
                <div class="bg-[#1a1c2e] p-10 rounded-3xl border border-gray-800 hover:border-purple-500 transition-all duration-300 group hover:-translate-y-2 hover:shadow-2xl hover:shadow-purple-500/10 flex flex-col items-center text-center cursor-pointer h-full"
                    onclick="enterAdminPortal()">
                    <div
                        class="w-24 h-24 rounded-full bg-purple-500/10 flex items-center justify-center mb-8 group-hover:scale-110 transition-transform duration-300">
                        <i class="fas fa-user-shield text-4xl text-purple-400"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-white mb-4">Administrator</h3>
                    <p class="text-gray-400 text-base mb-10 leading-relaxed flex-grow">System configuration, user
                        management, and institutional oversight.</p>
                    <button
                        class="w-full py-4 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-bold text-lg transition-all shadow-lg hover:shadow-purple-500/25">
                        Login as Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Login/Register (Hidden by default, shown after clicking Student) -->
        <div id="student-auth" class="hidden w-full max-w-md">
            <!-- Home Screen (Student Portal Entry) -->
            <div id="home-screen" class="bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-700">
                <header class="text-center mb-10">
                    <h1 class="text-3xl font-bold text-white mb-3">Student Login</h1>
                    <p class="text-gray-400">Secure Face Recognition Access</p>
                </header>

                <div class="space-y-6">
                    <div class="flex flex-col space-y-4">
                        <button onclick="showLogin()"
                            class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 transition transform hover:scale-[1.02] shadow-lg shadow-blue-500/20">
                            Log In with Face ID
                        </button>
                        <button onclick="showRegister()"
                            class="w-full py-4 bg-gray-700 text-white rounded-xl font-bold text-lg hover:bg-gray-600 transition transform hover:scale-[1.02]">
                            Register New Account
                        </button>
                    </div>
                    <button onclick="backToRoles()"
                        class="w-full text-center text-gray-500 hover:text-gray-300 mt-4 text-sm">
                        &larr; Back to Role Selection
                    </button>
                </div>
            </div>

            <!-- Register Screen -->
            <div id="register-screen" class="hidden bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-8">New Student Registration</h2>

                <!-- Step 1: Email Verification -->
                <div id="reg-step-email" class="space-y-6 animate-fade-in">
                    <div class="text-center text-gray-400 mb-4">
                        <i class="fas fa-envelope text-4xl mb-4 text-blue-400"></i>
                        <p class="text-lg">Verify your college email</p>
                        <p class="text-xs text-gray-500 mt-1">We will send a One Time Password (OTP)</p>
                    </div>

                    <div id="email-form">
                        <input type="email" id="reg-email" placeholder="student@college.edu"
                            class="w-full p-4 mb-4 rounded-xl border border-gray-600 bg-gray-700/50 text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                        <button onclick="sendOTP()"
                            class="w-full py-3 bg-blue-600 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-500/20 transition-all">
                            Send OTP
                        </button>
                    </div>

                    <div id="otp-form" class="hidden animate-fade-in">
                        <p class="text-sm text-gray-400 mb-2">Enter OTP code:</p>
                        <input type="text" id="reg-otp" placeholder="XXXX" maxlength="4"
                            class="w-full p-4 mb-4 rounded-xl border border-gray-600 bg-gray-700/50 text-white text-center tracking-[1em] text-2xl font-mono outline-none focus:ring-2 focus:ring-green-500 transition-all">
                        <button onclick="verifyOTP()"
                            class="w-full py-3 bg-green-600 rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-500/20 transition-all">
                            Verify & Continue
                        </button>
                        <button
                            onclick="document.getElementById('otp-form').classList.add('hidden'); document.getElementById('email-form').classList.remove('hidden');"
                            class="text-xs text-gray-500 mt-4 underline hover:text-gray-300">Change Email</button>
                    </div>
                </div>

                <!-- Step 2: Face Registration (Hidden until Verified) -->
                <div id="reg-step-face" class="hidden animate-fade-in">
                    <div
                        class="camera-container rounded-2xl overflow-hidden mb-6 shadow-2xl mx-auto border-2 border-gray-700 w-full aspect-video bg-black relative">
                        <video id="video-reg" class="w-full h-full object-cover"></video>
                        <canvas id="canvas-reg" class="absolute top-0 left-0 w-full h-full"></canvas>

                        <!-- Challenge Overlay -->
                        <div id="liveness-overlay"
                            class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 hidden backdrop-blur-sm">
                            <div id="challenge-icon-container" class="mb-4 transform transition-all duration-300">
                                <i id="challenge-icon" class="fas fa-smile text-6xl text-yellow-400"></i>
                            </div>
                            <h3 id="challenge-text"
                                class="text-3xl font-bold text-white mb-2 text-center drop-shadow-lg">Task 1: Smile</h3>
                            <p id="challenge-sub" class="text-gray-300 text-sm">Keep your face visible</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <input type="text" id="username-input" placeholder="Enter your full name"
                            class="w-full p-4 rounded-xl border border-gray-600 bg-gray-700/50 text-white focus:ring-2 focus:ring-blue-500 font-medium transition-all">

                        <!-- Initial Start Button -->
                        <button id="register-btn"
                            class="w-full py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl font-bold text-lg hover:from-purple-700 hover:to-indigo-700 shadow-lg shadow-purple-500/20 transition-all transform hover:scale-[1.02]">
                            Start Verification
                        </button>
                        <p class="text-xs text-center text-gray-500">You will be asked to perform 3 simple actions.</p>
                    </div>
                </div>

                <button onclick="goHome()" class="w-full mt-6 text-sm text-gray-400 hover:text-white transition">&larr;
                    Cancel</button>
            </div>

            <!-- Login Screen -->
            <div id="login-screen" class="hidden bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-700">
                <h2 class="text-2xl font-bold text-center mb-8">Verify Identity</h2>
                <div
                    class="camera-container rounded-2xl overflow-hidden mb-8 shadow-2xl mx-auto border-2 border-gray-700 w-full aspect-video bg-black relative">
                    <video id="video-login" class="w-full h-full object-cover"></video>
                    <canvas id="canvas-login" class="absolute top-0 left-0 w-full h-full"></canvas>

                    <!-- Login Liveness Overlay -->
                    <div id="liveness-overlay-login"
                        class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-20 hidden backdrop-blur-sm">
                        <div id="challenge-icon-container-login" class="mb-4 transform transition-all duration-300">
                            <i id="challenge-icon-login" class="fas fa-smile text-6xl text-yellow-400"></i>
                        </div>
                        <h3 id="challenge-text-login"
                            class="text-3xl font-bold text-white mb-2 text-center drop-shadow-lg">Task 1: Smile</h3>
                        <p id="challenge-sub-login" class="text-gray-300 text-sm">Keep your face visible</p>
                    </div>
                </div>
                <button id="login-btn"
                    class="w-full py-4 bg-blue-600 text-white rounded-xl font-bold text-lg hover:bg-blue-700 transition transform hover:scale-[1.02] shadow-lg shadow-blue-500/20"
                    disabled>Authenticate</button>
                <button onclick="goHome()" class="w-full mt-6 text-sm text-gray-400 hover:text-white transition">&larr;
                    Cancel</button>
            </div>

            <!-- Loading -->
            <div id="loading" class="hidden text-center bg-gray-800 p-8 rounded-3xl shadow-xl">
                <svg class="animate-spin h-12 w-12 text-blue-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg"
                    fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                    </circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <h3 class="text-xl font-bold text-white">Initializing AI</h3>
                <p class="text-gray-400 mt-2">Loading secure face models...</p>
            </div>
        </div>
    </div>
    <!-- Navigation Bar (Hidden on Landing) -->
    <nav id="navbar" class="hidden bg-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-graduation-cap text-2xl"></i>
                    <span class="text-xl font-bold">spark</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="hidden md:flex flex-col text-right">
                        <span class="font-semibold" id="nav-username">User</span>
                        <span class="text-sm text-blue-200" id="nav-class">Computer Science</span>
                    </div>
                    <img class="h-10 w-10 rounded-full border-2 border-white"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                        alt="Profile">
                    <button class="bg-blue-700 hover:bg-blue-800 px-4 py-2 rounded-lg transition"
                        onclick="logout()">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Tabs (Hidden on Landing) -->
    <div id="mobile-tabs" class="hidden bg-gray-800 shadow-md md:hidden">
        <div class="flex overflow-x-auto">
            <button class="tab-btn px-4 py-3 font-medium text-blue-400 border-b-2 border-blue-400"
                data-tab="attendance">
                <i class="fas fa-fingerprint mr-2"></i>Attendance
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="timetable">
                <i class="fas fa-calendar-alt mr-2"></i>Timetable
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="rescheduler">
                <i class="fas fa-exchange-alt mr-2"></i>Rescheduler
            </button>
            <button class="tab-btn px-4 py-3 font-medium text-gray-400" data-tab="suggestions">
                <i class="fas fa-lightbulb mr-2"></i>Suggestions
            </button>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden initially) -->
    <div id="main-app" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Desktop) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <img class="h-24 w-24 rounded-full mb-4 border-4 border-blue-500"
                            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                            alt="Profile">
                        <h2 class="text-xl font-bold" id="sidebar-username">User</h2>
                        <p class="text-gray-400" id="sidebar-id">CS2021BATCH</p>
                        <div class="mt-2 bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">ID Verified</div>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-blue-400 bg-blue-900/50 border border-blue-500/20"
                            data-tab="dashboard-home">
                            <i class="fas fa-home mr-3"></i>Dashboard
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Timetable
                        </button>
                        <!-- Rescheduler Removed from Student Panel -->
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="suggestions">
                            <i class="fas fa-lightbulb mr-3"></i>Suggestions
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="profile">
                            <i class="fas fa-user mr-3"></i>Profile
                        </button>
                        <button
                            class="tab-btn w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="routine">
                            <i class="fas fa-clock mr-3"></i>Daily Routine
                        </button>
                    </nav>
                </div>

                <div class="bg-gray-800 rounded-lg shadow-md p-4">
                    <h3 class="font-bold text-lg mb-3">Today's Schedule</h3>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">9:00</div>
                            <div>
                                <div class="font-medium">Data Structures</div>
                                <div class="text-xs text-gray-400">Room 302</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-blue-900 text-blue-200 text-xs font-bold px-2 py-1 rounded mr-3">10:00</div>
                            <div>
                                <div class="font-medium">Algorithms</div>
                                <div class="text-xs text-gray-400">Room 305</div>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="bg-green-900 text-green-200 text-xs font-bold px-2 py-1 rounded mr-3">11:00
                            </div>
                            <div>
                                <div class="font-medium">Free Period</div>
                                <div class="text-xs text-gray-400">Library</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content (Dashboard & Tabs) -->
            <div class="w-full md:w-3/4 lg:w-4/5">
                <!-- Dashboard Content (Initially Hidden) -->
                <div id="dashboard-content">
                    <!-- Dashboard Home Tab -->
                    <div id="dashboard-home" class="tab-content active">
                        <!-- Welcome Banner -->
                        <div
                            class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-[#4f46e5] to-[#7c3aed] p-8 mb-8 shadow-2xl">
                            <div
                                class="absolute top-0 right-0 -mt-4 -mr-4 w-32 h-32 rounded-full bg-white opacity-10 blur-xl">
                            </div>
                            <div
                                class="absolute bottom-0 left-0 -mb-4 -ml-4 w-24 h-24 rounded-full bg-blue-300 opacity-10 blur-xl">
                            </div>
                            <div class="relative z-10 flex justify-between items-end">
                                <div>
                                    <h1 class="text-3xl font-bold text-white mb-2">Welcome back, <span
                                            class="banner-username">User</span>!</h1>
                                    <p class="text-blue-100">Here's what's happening today</p>
                                </div>
                                <div class="text-right hidden sm:block">
                                    <div class="text-sm text-blue-200" id="current-date-display">Wednesday, January 14,
                                        2026
                                    </div>
                                    <div class="text-2xl font-bold text-white space-mono" id="current-time-display">
                                        09:09 PM
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <!-- Card 1 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-blue-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Today's Attendance</p>
                                        <h3 class="text-2xl font-bold text-white" id="today-attendance-count">0/0</h3>
                                    </div>
                                    <div class="p-2 bg-blue-500/10 rounded-lg text-blue-400">
                                        <i class="fas fa-fingerprint text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 2 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-green-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Upcoming Classes</p>
                                        <h3 class="text-2xl font-bold text-white">2</h3>
                                    </div>
                                    <div class="p-2 bg-green-500/10 rounded-lg text-green-400">
                                        <i class="fas fa-calendar-check text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 3 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-amber-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">This Week</p>
                                        <h3 class="text-2xl font-bold text-white">0%</h3>
                                    </div>
                                    <div class="p-2 bg-amber-500/10 rounded-lg text-amber-400">
                                        <i class="fas fa-chart-line text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Card 4 -->
                            <div
                                class="bg-[#1a1c2e] p-5 rounded-xl border-l-4 border-purple-500 shadow-lg relative overflow-hidden group hover:bg-[#202336] transition-colors">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="text-gray-400 text-sm font-medium mb-1">Total Classes</p>
                                        <h3 class="text-2xl font-bold text-white">12</h3>
                                    </div>
                                    <div class="p-2 bg-purple-500/10 rounded-lg text-purple-400">
                                        <i class="fas fa-book text-xl"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Quick Actions -->
                            <div class="lg:col-span-2 space-y-6">
                                <h3 class="flex items-center text-lg font-bold text-yellow-400">
                                    <i class="fas fa-bolt mr-2"></i> Quick Actions
                                </h3>

                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <button
                                        class="bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="document.querySelector('[data-tab=attendance]').click()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                        <span class="font-bold">Mark Attendance</span>
                                    </button>

                                    <button
                                        class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="document.querySelector('[data-tab=timetable]').click()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-calendar-alt"></i>
                                        </div>
                                        <span class="font-bold">View Timetable</span>
                                    </button>

                                    <button
                                        class="bg-purple-600 hover:bg-purple-700 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="document.querySelector('[data-tab=suggestions]').click()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-lightbulb"></i>
                                        </div>
                                        <span class="font-bold">Suggestions</span>
                                    </button>

                                    <button
                                        class="bg-gray-700 hover:bg-gray-600 text-white p-6 rounded-xl shadow-lg transition transform hover:-translate-y-1 flex flex-col items-center justify-center gap-3 h-32"
                                        onclick="document.querySelector('[data-tab=profile]').click()">
                                        <div
                                            class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-2xl">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <span class="font-bold">My Profile</span>
                                    </button>
                                </div>

                                <!-- Recent Activity Section -->
                                <div class="mt-8">
                                    <h3 class="flex items-center text-lg font-bold text-gray-200 mb-4">
                                        <i class="fas fa-history mr-2"></i> Recent Activity
                                    </h3>
                                    <div id="recent-activity-list" class="space-y-4">
                                        <!-- Dynamic activity logs will appear here -->
                                        <p class="text-gray-500 text-center py-4">No recent activity.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Today's Schedule Column -->
                            <div class="bg-[#1a1c2e] p-6 rounded-xl border border-gray-800 shadow-lg h-full">
                                <h3 class="flex items-center text-lg font-bold text-blue-400 mb-6">
                                    <i class="fas fa-clock mr-2"></i> Today's Schedule
                                </h3>

                                <div class="space-y-4">
                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-green-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-blue-600/90 text-white text-xs font-bold px-2 py-1 rounded">9:00</span>
                                            <span
                                                class="text-[10px] text-green-400 bg-green-900/40 px-2 py-0.5 rounded-full border border-green-900">Completed</span>
                                        </div>
                                        <h4 class="font-bold text-white">Data Structures</h4>
                                        <p class="text-xs text-gray-400 mt-1">Room 302 • Prof. Sharma</p>
                                    </div>

                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-amber-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-blue-600/90 text-white text-xs font-bold px-2 py-1 rounded">10:00</span>
                                            <span
                                                class="text-[10px] text-amber-400 bg-amber-900/40 px-2 py-0.5 rounded-full border border-amber-900">In
                                                Progress</span>
                                        </div>
                                        <h4 class="font-bold text-white">Algorithms</h4>
                                        <p class="text-xs text-gray-400 mt-1">Room 305 • Prof. Gupta</p>
                                    </div>

                                    <div class="bg-gray-800/50 p-4 rounded-xl border-l-4 border-blue-500 relative">
                                        <div class="flex justify-between items-start mb-1">
                                            <span
                                                class="bg-green-600/90 text-white text-xs font-bold px-2 py-1 rounded">11:00</span>
                                            <span
                                                class="text-[10px] text-blue-400 bg-blue-900/40 px-2 py-0.5 rounded-full border border-blue-900">Upcoming</span>
                                        </div>
                                        <h4 class="font-bold text-white">Free Period</h4>
                                        <p class="text-xs text-gray-400 mt-1">Library • Self Study</p>
                                    </div>
                                </div>

                                <button onclick="document.querySelector('[data-tab=timetable]').click()"
                                    class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold text-sm transition shadow-lg">
                                    View Full Timetable →
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Tab -->
                    <div id="attendance" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Mark Attendance</h2>

                            <!-- Camera View -->
                            <div id="attendance-camera-view"
                                class="camera-container rounded-3xl overflow-hidden mb-6 shadow-md mx-auto"
                                style="max-width: 500px;">
                                <video id="video-attendance" class="block bg-black"></video>
                                <canvas id="canvas-attendance" class="block"></canvas>
                            </div>

                            <!-- Locked/Success View (Initially Hidden) -->
                            <div id="attendance-locked-view"
                                class="hidden rounded-3xl mb-6 shadow-md mx-auto bg-green-900/20 border border-green-500/30 flex flex-col items-center justify-center py-12"
                                style="max-width: 500px; height: 375px;">
                                <div
                                    class="w-24 h-24 rounded-full bg-green-500 flex items-center justify-center mb-6 shadow-lg shadow-green-500/50 animate-bounce">
                                    <i class="fas fa-check text-4xl text-white"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-2">Attendance Marked</h3>
                                <p class="text-green-300">You have successfully checked in.</p>
                            </div>
                            <div id="attendance-portal-message"
                                class="hidden text-center p-6 bg-red-900/20 border border-red-500/30 rounded-2xl mb-6">
                                <i class="fas fa-lock text-3xl text-red-500 mb-2"></i>
                                <h4 class="text-lg font-bold text-white">Portal Closed</h4>
                                <p class="text-sm text-gray-400">Your teacher hasn't opened the attendance portal for
                                    the current class yet.</p>
                            </div>

                            <button id="mark-attendance-btn"
                                class="w-full px-8 py-3 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>Mark Attendance with Face Recognition</button>

                            <div id="attendance-timer-container"
                                class="hidden mt-6 bg-yellow-900/30 border border-yellow-600/50 p-4 rounded-xl text-center">
                                <p class="text-yellow-400 font-bold mb-2"><i class="fas fa-lock mr-2"></i>Attendance
                                    Locked</p>
                                <p class="text-gray-300 text-sm mb-2" id="attendance-lock-msg">Class in progress</p>
                                <div class="text-3xl font-mono text-white" id="attendance-countdown">00:00:00</div>
                            </div>
                            <div class="mt-8">
                                <h3 class="text-xl font-semibold mb-4">Today's Attendance</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full bg-gray-700 rounded-lg">
                                        <thead>
                                            <tr>
                                                <th class="py-2 px-4 border-b border-gray-600">Class</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Time</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Method</th>
                                                <th class="py-2 px-4 border-b border-gray-600">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td class="py-2 px-4 border-b border-gray-600">Data Structures</td>
                                                <td class="py-2 px-4 border-b border-gray-600">9:00 AM</td>
                                                <td class="py-2 px-4 border-b border-gray-600">Face</td>
                                                <td class="py-2 px-4 border-b border-gray-600">
                                                    <span
                                                        class="px-2 py-1 rounded-full text-xs bg-green-800 text-green-200">Present</span>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="py-2 px-4 border-b border-gray-600">Algorithms</td>
                                                <td class="py-2 px-4 border-b border-gray-600">10:00 AM</td>
                                                <td class="py-2 px-4 border-b border-gray-600">-</td>
                                                <td class="py-2 px-4 border-b border-gray-600">
                                                    <span
                                                        class="px-2 py-1 rounded-full text-xs bg-yellow-800 text-yellow-200">Pending</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Timetable Tab -->
                    <div id="timetable" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md min-h-[600px]">
                            <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-6">
                                <div>
                                    <h2 class="text-3xl font-bold text-white mb-2">My Schedule</h2>
                                    <p class="text-gray-400">Manage your weekly classes and timings</p>
                                </div>
                                <div class="flex gap-3">
                                    <button onclick="document.getElementById('timetable-upload').click()"
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl flex items-center shadow-lg shadow-blue-500/20 transition-all transform hover:scale-105 active:scale-95 border border-blue-500/30">
                                        <i class="fas fa-file-upload mr-2"></i> Import Excel/PDF
                                    </button>
                                    <input type="file" id="timetable-upload" class="hidden" accept=".xlsx,.xls,.pdf"
                                        onchange="handleTimetableUpload(this)">
                                </div>
                            </div>

                            <!-- Timetable Display/Edit Area -->
                            <div id="timetable-display" class="space-y-6">
                                <!-- Empty State -->
                                <div id="timetable-empty"
                                    class="flex flex-col items-center justify-center py-20 border-2 border-dashed border-gray-700/50 rounded-3xl bg-gray-800/30">
                                    <div
                                        class="w-20 h-20 rounded-full bg-gray-700/50 flex items-center justify-center mb-6 ring-4 ring-gray-800">
                                        <i class="fas fa-calendar-alt text-3xl text-gray-500"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-gray-200 mb-2">No Schedule Found</h3>
                                    <p class="text-gray-400 max-w-md text-center mb-8 leading-relaxed">
                                        Upload your class schedule to get started.<br>
                                        <span class="text-sm opacity-70">Supported formats: Excel (.xlsx) or PDF with 3
                                            columns (Teacher, Subject, Time)</span>
                                    </p>
                                    <button onclick="document.getElementById('timetable-upload').click()"
                                        class="text-blue-400 hover:text-blue-300 font-semibold hover:underline decoration-2 underline-offset-4">
                                        Browse from computer
                                    </button>
                                </div>

                                <!-- Table Editor (Hidden initially) -->
                                <div id="timetable-container" class="hidden animate-fade-in">
                                    <div
                                        class="overflow-hidden rounded-2xl border border-gray-700/50 shadow-2xl bg-[#0b1220]">
                                        <table class="w-full text-left border-collapse">
                                            <thead>
                                                <tr
                                                    class="bg-gray-900/50 text-gray-400 text-sm uppercase tracking-wider">
                                                    <th class="p-5 font-semibold border-b border-gray-800">Time / Slot
                                                    </th>
                                                    <th class="p-5 font-semibold border-b border-gray-800">Subject</th>
                                                    <th class="p-5 font-semibold border-b border-gray-800">Teacher</th>
                                                    <th class="p-5 font-semibold border-b border-gray-800 text-right">
                                                        Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="timetable-body"
                                                class="divide-y divide-gray-800/50 text-gray-300">
                                                <!-- Rows will be injected here -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <div
                                        class="flex justify-between items-center mt-6 pt-6 border-t border-gray-700/30 sticky bottom-0 bg-gray-800 backdrop-blur-sm z-10">
                                        <button onclick="addTimetableRow()"
                                            class="text-blue-400 hover:text-blue-300 font-medium flex items-center px-4 py-2 hover:bg-blue-500/10 rounded-lg transition-colors">
                                            <i class="fas fa-plus-circle mr-2"></i> Add Class Slot
                                        </button>
                                        <button onclick="saveTimetableComp()"
                                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-green-500/20 transition-all transform hover:-translate-y-1 active:translate-y-0">
                                            Save Schedule
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rescheduler Tab -->
                    <div id="rescheduler" class="tab-content">
                        <div class="panel">
                            <div class="flex-between">
                                <div>
                                    <strong>Step 1 — Setup</strong>
                                    <div style="color:var(--muted); font-size:13px; margin-top:6px">Add classes and
                                        subjects. Each subject needs a teacher and class average for that subject.</div>
                                </div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn" id="addClassBtn">+ Add Class</button>
                                    <button class="btn ghost" id="resetBtn">Reset All</button>
                                </div>
                            </div>

                            <div class="classes" id="classesContainer"></div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div style="margin-top:8px">
                                <div class="row">
                                    <label class="small">Number of lectures (per day)</label>
                                    <input id="periodCount" class="input" type="number" min="1" value="6" />
                                    <label class="small">(Name your lectures optional - left blank uses
                                        P1,P2...)</label>
                                </div>

                                <div class="row" style="margin-top:10px">
                                    <label class="small">Create Timetable for each class (use the subject names you
                                        added, comma separated per lectures )</label>
                                    <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:8px"
                                        id="timetablesInputs"></div>
                                </div>
                            </div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div>
                                <strong>Step 2 — Absent Teacher(s)</strong>
                                <div style="color:var(--muted); font-size:13px; margin-top:6px">Select which teacher(s)
                                    are absent today. You can add multiple absent teachers.</div>

                                <div class="absent-list" id="absentList"></div>
                                <div style="margin-top:10px">
                                    <select id="absentTeacherSelect" class="input"></select>
                                    <button class="btn" id="addAbsentBtn" style="margin-left:8px">+ Add Absent</button>
                                </div>
                            </div>

                            <hr
                                style="border:none; height:1px; margin:14px 0; background:linear-gradient(90deg, transparent, rgba(124,77,255,0.06), transparent)">

                            <div class="flex-between" style="margin-top:8px">
                                <div style="color:var(--muted)">Preview timetable & teacher assignment below (editable)
                                </div>
                                <div>
                                    <button class="btn warn" id="previewBtn">Preview Timetable</button>
                                    <button class="btn" id="regenBtn">Regenerate Schedule →</button>
                                </div>
                            </div>

                            <div class="timetable" id="previewArea" style="display:none; margin-top:12px"></div>
                        </div>

                        <!-- Result View -->
                        <div id="resultView" class="panel" style="display:none; margin-top: 20px;">
                            <div class="result-title">
                                <div>
                                    <strong>Regenerated Day Timetable</strong>
                                    <div style="color:var(--muted); font-size:13px; margin-top:6px">Rules applied:
                                        absent teachers removed → available teachers reassigned per-period → one teacher
                                        per period → most needy class gets priority</div>
                                </div>
                                <div>
                                    <span class="badge" id="absentBadge">Absent: 0</span>
                                </div>
                            </div>

                            <div style="margin-top:12px" id="resultTablesContainer"></div>

                            <div style="margin-top:14px; display:flex; gap:10px">
                                <button class="btn ghost" id="backBtn">← Back & Edit</button>
                                <button class="btn" id="downloadBtn">Download CSV</button>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions Tab -->
                    <div id="suggestions" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-4">Free Time Suggestions</h2>
                            <p class="text-gray-400 mb-6">Based on your interests in <span class="font-semibold">Web
                                    Development, Machine Learning, and Data Structures</span></p>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-blue-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-code text-blue-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Practice JavaScript Algorithms</h3>
                                            <p class="text-sm text-gray-400">15-20 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Solve 2-3 algorithm challenges to improve your
                                        problem-solving skills.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Coding</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('algorithms')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-purple-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-brain text-purple-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Read ML Research Paper</h3>
                                            <p class="text-sm text-gray-400">25-30 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Read a summary of recent advances in transformer
                                        models.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Machine
                                            Learning</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('ml')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-green-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-book text-green-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Review Data Structures</h3>
                                            <p class="text-sm text-gray-400">20-25 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Revise tree traversal algorithms and practice
                                        implementation.</p>
                                    <div class="flex justify-between items-center">
                                        <span class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Study</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('ds')">Start Now</button>
                                    </div>
                                </div>

                                <div class="border border-gray-700 rounded-lg p-4 hover:shadow-md transition">
                                    <div class="flex items-start mb-3">
                                        <div class="bg-yellow-900 p-2 rounded-lg mr-4">
                                            <i class="fas fa-tasks text-yellow-400 text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold">Plan Your Project</h3>
                                            <p class="text-sm text-gray-400">10-15 minutes</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-300 mb-4">Outline the next steps for your web development
                                        project.</p>
                                    <div class="flex justify-between items-center">
                                        <span
                                            class="bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded">Planning</span>
                                        <button
                                            class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded"
                                            onclick="startSuggestion('project')">Start Now</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Profile Tab -->
                    <div id="profile" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">Student Profile</h2>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="md:col-span-1 flex flex-col items-center">
                                    <img class="h-32 w-32 rounded-full mb-4 border-4 border-blue-500"
                                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366F1'%3E%3Cpath d='M12 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10zm0 2c-6.627 0-12 5.373-12 12h24c0-6.627-5.373-12-12-12z'/%3E%3C/svg%3E"
                                        alt="Profile">
                                    <button class="text-blue-400 text-sm mt-2">Change Photo</button>
                                </div>

                                <div class="md:col-span-2">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Full
                                                Name</label>
                                            <input type="text" id="profile-name" value="enter your name "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">College
                                                ID</label>
                                            <input type="text" id="profile-id" value="enter college id "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Email</label>
                                            <input type="email" id="profile-email" value="enter your mail "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-400 mb-1">Course</label>
                                            <input type="text" id="profile-course" value="enter your course "
                                                class="w-full px-4 py-2 border border-gray-600 rounded-lg bg-gray-700 text-white">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-3">Interests</h3>
                                <div class="flex flex-wrap gap-2">
                                    <span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm">Web
                                        Development</span>
                                    <span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm">Machine
                                        Learning</span>
                                    <span class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm">Data
                                        Structures</span>
                                    <span
                                        class="bg-blue-900 text-blue-200 px-3 py-1 rounded-full text-sm">Algorithms</span>
                                    <button class="text-blue-400 text-sm">+ Add more</button>
                                </div>
                            </div>

                            <div class="mb-6">
                                <h3 class="text-lg font-semibold mb-3">Career Goals</h3>
                                <textarea id="profile-goals"
                                    class="w-full px-4 py-2 border border-gray-600 rounded-lg h-24 bg-gray-700 text-white">I want to become a full-stack developer with expertise in React and Node.js, and eventually move into AI engineering.</textarea>
                            </div>

                            <div class="flex justify-end">
                                <button id="saveProfileBtn"
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">Save
                                    Changes</button>
                            </div>
                        </div>
                    </div>

                    <!-- Routine Tab -->
                    <div id="routine" class="tab-content">
                        <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                            <h2 class="text-2xl font-bold mb-6">Daily Routine</h2>

                            <div class="mb-6 flex justify-between items-center">
                                <div class="text-lg font-semibold">Monday, 12 June 2023</div>
                                <button id="exportRoutineBtn" class="bg-blue-900 text-blue-200 px-4 py-2 rounded-lg">
                                    <i class="fas fa-download mr-2"></i>Export Routine
                                </button>
                            </div>

                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">7:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Morning Routine</h3>
                                        <p class="text-sm text-gray-400">Exercise, Breakfast</p>
                                    </div>
                                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">9:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Data Structures Class</h3>
                                        <p class="text-sm text-gray-400">Room 302</p>
                                    </div>
                                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">10:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Algorithms Class</h3>
                                        <p class="text-sm text-gray-400">Room 305</p>
                                    </div>
                                    <div class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In
                                        Progress</div>
                                </div>

                                <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                    <div class="w-16 text-green-200 font-bold">11:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Free Period - Suggested Activity</h3>
                                        <p class="text-sm text-gray-400">Practice JavaScript Algorithms (15 min)</p>
                                    </div>
                                    <div class="bg-blue-800 text-blue-200 text-xs px-2 py-1 rounded-full">Upcoming</div>
                                </div>

                                <div class="flex items-center p-4 bg-gray-700 rounded-lg">
                                    <div class="w-16 text-gray-300 font-bold">12:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Lunch Break</h3>
                                        <p class="text-sm text-gray-400">Cafeteria</p>
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-blue-900 rounded-lg">
                                    <div class="w-16 text-blue-200 font-bold">14:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Database Systems Class</h3>
                                        <p class="text-sm text-gray-400">Room 401</p>
                                    </div>
                                    <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not Started
                                    </div>
                                </div>

                                <div class="flex items-center p-4 bg-green-900 rounded-lg">
                                    <div class="w-16 text-green-200 font-bold">16:00</div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold">Free Time - Suggested Activity</h3>
                                        <p class="text-sm text-gray-400">Read ML Research Paper (25 min)</p>
                                    </div>
                                    <div class="bg-gray-600 text-gray-300 text-xs px-2 py-1 rounded-full">Not Started
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN DASHBOARD (Hidden initially) -->
    <div id="admin-dashboard" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Admin) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div
                            class="w-24 h-24 rounded-full bg-purple-500/10 flex items-center justify-center mb-4 border-4 border-purple-500">
                            <i class="fas fa-user-shield text-4xl text-purple-400"></i>
                        </div>
                        <h2 class="text-xl font-bold">Admin</h2>
                        <p class="text-gray-400">System Administrator</p>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-purple-400 bg-purple-900/50 border border-purple-500/20"
                            data-tab="admin-data">
                            <i class="fas fa-database mr-3"></i>Data Management
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Timetable
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="admin-results">
                            <i class="fas fa-poll mr-3"></i>Results
                        </button>
                        <button
                            class="tab-btn-admin w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            onclick="logoutAdmin()">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Main Content (Admin) -->
            <div class="w-full md:w-3/4 lg:w-4/5">

                <!-- Data Management Tab -->
                <div id="admin-data" class="tab-content-admin active">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Data Management</h2>

                        <!-- Actions Row -->
                        <div class="flex space-x-4 mb-6 border-b border-gray-700 pb-2">
                            <button onclick="showAdminSection('add')"
                                class="sub-tab-btn text-blue-400 font-semibold border-b-2 border-blue-400 pb-1"
                                data-sub="add">Add Data</button>
                            <button onclick="showAdminSection('remove')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="remove">Remove Data</button>
                            <button onclick="showAdminSection('modify')"
                                class="sub-tab-btn text-gray-400 hover:text-white font-semibold pb-1"
                                data-sub="modify">Modify/Classify</button>
                        </div>

                        <!-- Add Section -->
                        <div id="admin-sub-add" class="admin-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <!-- Manual Add -->
                                <div>
                                    <h3 class="text-lg font-semibold mb-3 text-purple-300">Manual Entry</h3>
                                    <div class="space-y-4">
                                        <input type="text" id="admin-add-name" placeholder="Full Name"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                        <input type="text" id="admin-add-id" placeholder="ID (e.g. CS202501)"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                        <select id="admin-add-role"
                                            class="w-full p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-purple-500 outline-none">
                                            <option value="student">Student</option>
                                            <option value="teacher">Teacher</option>
                                        </select>
                                        <button onclick="adminAddUserManual()"
                                            class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl shadow-lg shadow-purple-500/20 transition">
                                            Add User
                                        </button>
                                    </div>
                                </div>

                                <!-- Bulk Import -->
                                <div class="border-l border-gray-700 pl-8">
                                    <h3 class="text-lg font-semibold mb-3 text-green-300">Bulk Import</h3>
                                    <div class="border-2 border-dashed border-gray-600 rounded-xl p-8 text-center hover:bg-gray-700/30 transition cursor-pointer flex flex-col items-center justify-center h-64 group"
                                        onclick="document.getElementById('admin-file-upload').click()">
                                        <div
                                            class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center mb-4 group-hover:scale-110 transition">
                                            <i
                                                class="fas fa-file-import text-3xl text-gray-400 group-hover:text-white"></i>
                                        </div>
                                        <p class="text-gray-300 font-medium">Click to upload Excel/PDF</p>
                                        <p class="text-gray-500 text-sm mt-2">Supports .xlsx, .pdf</p>
                                        <input type="file" id="admin-file-upload" class="hidden"
                                            accept=".xlsx,.xls,.pdf,.csv" onchange="handleAdminFileUpload(this)">
                                    </div>
                                    <div id="admin-upload-status" class="mt-4 text-sm text-gray-400 text-center"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Remove Section -->
                        <div id="admin-sub-remove" class="admin-sub-content hidden">
                            <div class="flex gap-4 mb-6">
                                <input type="text" id="admin-search-remove" placeholder="Search by name or ID..."
                                    class="flex-1 p-4 bg-gray-700/50 border border-gray-600 rounded-xl text-white focus:border-red-500 outline-none">
                            </div>
                            <div id="admin-remove-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                <!-- Dynamic List -->
                                <div class="text-gray-500 text-center py-4">Search to find users to remove</div>
                            </div>
                        </div>

                        <!-- Modify/Classify Section -->
                        <div id="admin-sub-modify" class="admin-sub-content hidden">
                            <div class="flex flex-wrap gap-4 mb-6">
                                <select id="admin-filter-role"
                                    class="p-3 bg-gray-700 rounded-xl text-white border border-gray-600"
                                    onchange="renderAdminUserTable()">
                                    <option value="all">All Roles</option>
                                    <option value="student">Student</option>
                                    <option value="teacher">Teacher</option>
                                </select>
                                <input type="text" id="admin-filter-search" placeholder="Filter users..."
                                    class="flex-1 p-3 bg-gray-700 rounded-xl text-white border border-gray-600"
                                    oninput="renderAdminUserTable()">
                            </div>

                            <div class="overflow-hidden rounded-xl border border-gray-700">
                                <table class="w-full text-left text-gray-300">
                                    <thead class="bg-gray-900 text-gray-400 uppercase text-xs font-bold">
                                        <tr>
                                            <th class="p-4">Name</th>
                                            <th class="p-4">ID</th>
                                            <th class="p-4">Role</th>
                                            <th class="p-4 text-right">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-user-table-body" class="divide-y divide-gray-800 bg-gray-800/50">
                                        <!-- Rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Attendance Management Tab -->
                <div id="admin-attendance" class="tab-content-admin hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-blue-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Total Check-ins</h4>
                            <div class="text-4xl font-bold text-white" id="admin-total-checkins">0</div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Active Classes</h4>
                            <div class="text-4xl font-bold text-white">3</div>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border-l-4 border-purple-500">
                            <h4 class="text-gray-400 text-sm font-bold uppercase mb-2">Faculty Present</h4>
                            <div class="text-4xl font-bold text-white">12</div>
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                        <h3 class="text-xl font-bold mb-6 flex items-center">
                            <i class="fas fa-list-alt mr-3 text-blue-400"></i> Today's Attendance Log
                        </h3>
                        <div class="text-sm text-gray-400 mb-4 bg-gray-900/50 p-3 rounded-lg">
                            <i class="fas fa-info-circle mr-2"></i> Data aggregated from Student/Teacher portals.
                        </div>
                        <div class="overflow-hidden rounded-xl border border-gray-700">
                            <table class="w-full text-left text-gray-300">
                                <thead class="bg-gray-900 text-gray-400 uppercase text-xs font-bold">
                                    <tr>
                                        <th class="p-4">Time</th>
                                        <th class="p-4">Class</th>
                                        <th class="p-4">Present Count</th>
                                        <th class="p-4 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-attendance-log-body" class="divide-y divide-gray-800 bg-gray-800/50">
                                    <!-- Dynamic content -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Timetable Management Tab -->
                <div id="admin-timetable" class="tab-content-admin hidden">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-lg text-center py-20">
                        <div
                            class="w-24 h-24 rounded-full bg-gray-700/50 flex items-center justify-center mx-auto mb-6">
                            <i class="fas fa-calendar-alt text-4xl text-gray-500"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">Master Schedule Management</h2>
                        <p class="text-gray-400 max-w-lg mx-auto mb-8">View and edit institution-wide timetables. Select
                            a department to begin.</p>
                        <button
                            class="px-8 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-500/20 transition">
                            Open Scheduler Tool
                        </button>
                    </div>
                </div>

                <!-- Result Management Tab -->
                <div id="admin-results" class="tab-content-admin hidden">
                    <div class="bg-gray-800 p-8 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-bold text-white mb-6">Result Processing</h2>
                        <div
                            class="border-2 border-dashed border-gray-600 rounded-2xl p-12 text-center bg-gray-900/30 hover:bg-gray-900/50 transition cursor-pointer group">
                            <i
                                class="fas fa-cloud-upload-alt text-5xl text-gray-500 group-hover:text-blue-400 mb-4 transition"></i>
                            <p class="text-xl font-medium text-white mb-2">Upload Result Sheets</p>
                            <p class="text-gray-400 text-sm">Drag & drop CSV or Excel files here</p>
                            <button
                                class="mt-6 px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-semibold transition">Select
                                Files</button>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-lg font-bold mb-4">Recent Uploads</h3>
                            <div class="bg-gray-900/50 rounded-xl p-4 text-gray-500 text-center text-sm">
                                No recent uploads found.
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- TEACHER DASHBOARD (Hidden initially) -->
    <div id="teacher-dashboard" class="hidden container mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Sidebar (Teacher) -->
            <div class="hidden md:block w-full md:w-1/4 lg:w-1/5">
                <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                    <div class="flex flex-col items-center text-center mb-6">
                        <div
                            class="w-24 h-24 rounded-full bg-green-500/10 flex items-center justify-center mb-4 border-4 border-green-500">
                            <i class="fas fa-chalkboard-teacher text-4xl text-green-400"></i>
                        </div>
                        <h2 class="text-xl font-bold" id="teacher-sidebar-name">Teacher</h2>
                        <p class="text-gray-400">Faculty Member</p>
                    </div>

                    <nav class="space-y-2">
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-green-400 bg-green-900/50 border border-green-500/20"
                            data-tab="teacher-attendance">
                            <i class="fas fa-fingerprint mr-3"></i>Attendance
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-timetable">
                            <i class="fas fa-calendar-alt mr-3"></i>Timetable
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-study">
                            <i class="fas fa-book-open mr-3"></i>Study Material
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            data-tab="teacher-results">
                            <i class="fas fa-poll mr-3"></i>Result Management
                        </button>
                        <button
                            class="tab-btn-teacher w-full text-left px-4 py-3 rounded-lg font-medium text-gray-400 hover:bg-gray-700/50 hover:text-gray-200 transition-colors"
                            onclick="logoutTeacher()">
                            <i class="fas fa-sign-out-alt mr-3"></i>Logout
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Main Content (Teacher) -->
            <div class="w-full md:w-3/4 lg:w-4/5">
                <!-- Attendance Management Section -->
                <div id="teacher-attendance" class="tab-content-teacher">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-6">
                        <h2 class="text-2xl font-bold mb-4">Attendance Management</h2>
                        <!-- Attendance Sub-tabs -->
                        <div class="flex space-x-6 mb-6 border-b border-gray-700">
                            <button onclick="showTeacherSection('attendance','your')"
                                class="teacher-sub-tab-btn text-green-400 font-semibold border-b-2 border-green-400 pb-2"
                                data-sub="your">Your Attendance</button>
                            <button onclick="showTeacherSection('attendance','student')"
                                class="teacher-sub-tab-btn text-gray-400 hover:text-white font-semibold pb-2"
                                data-sub="student">Student Attendance</button>
                        </div>

                        <!-- Your Attendance Section -->
                        <div id="teacher-sub-attendance-your" class="teacher-sub-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <button
                                    class="p-6 bg-green-900/30 border border-green-500/20 rounded-2xl hover:bg-green-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-check-double text-3xl text-green-400 mb-3"></i>
                                    <span class="font-bold">Mark Attendance</span>
                                </button>
                                <button
                                    class="p-6 bg-blue-900/30 border border-blue-500/20 rounded-2xl hover:bg-blue-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-history text-3xl text-blue-400 mb-3"></i>
                                    <span class="font-bold">Attendance History</span>
                                </button>
                                <button
                                    class="p-6 bg-purple-900/30 border border-purple-500/20 rounded-2xl hover:bg-purple-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-chart-pie text-3xl text-purple-400 mb-3"></i>
                                    <span class="font-bold">Analysis</span>
                                </button>
                            </div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                                <h3 class="font-bold mb-4">Your Recent Logs</h3>
                                <p class="text-gray-500 text-center py-4 text-sm italic">No recent self-attendance logs
                                    found.</p>
                            </div>
                        </div>

                        <!-- Student Attendance Section -->
                        <div id="teacher-sub-attendance-student" class="teacher-sub-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                <button
                                    class="p-6 bg-teal-900/30 border border-teal-500/20 rounded-2xl hover:bg-teal-900/50 transition flex flex-col items-center">
                                    <i class="fas fa-user-check text-3xl text-teal-400 mb-3"></i>
                                    <span class="font-bold">Mark Student Attendance</span>
                                </button>
                                <button
                                    class="p-6 bg-amber-900/20 border border-amber-500/20 rounded-2xl hover:bg-amber-900/40 transition flex flex-col items-center">
                                    <i class="fas fa-analytics text-3xl text-amber-400 mb-3"></i>
                                    <span class="font-bold">Attendance Analysis</span>
                                </button>
                            </div>
                            <!-- Class Dropdown & Portal Controls -->
                            <div
                                class="mb-6 flex flex-wrap items-center gap-6 p-4 bg-gray-900/30 rounded-xl border border-gray-700">
                                <div class="flex items-center gap-3">
                                    <label class="text-sm text-gray-400">Select Class:</label>
                                    <select id="teacher-portal-class-select"
                                        class="bg-gray-700 border-gray-600 rounded-lg text-sm p-2 outline-none text-white focus:border-green-500">
                                        <option value="Computer Science - A">Computer Science - A</option>
                                        <option value="Computer Science - B">Computer Science - B</option>
                                        <option value="Mechanical Eng - A">Mechanical Eng - A</option>
                                        <option value="Data Structures">Data Structures</option>
                                        <option value="Algorithms">Algorithms</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-3 border-l border-gray-700 pl-6">
                                    <span class="text-sm text-gray-400">Portal Status:</span>
                                    <span id="attendance-portal-status-badge"
                                        class="px-3 py-1 bg-red-900/40 text-red-400 text-xs font-bold rounded-full border border-red-900/50">CLOSED</span>
                                </div>

                                <div class="flex gap-2 ml-auto">
                                    <button id="btn-open-portal" onclick="toggleAttendancePortal(true)"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-xs font-bold rounded-lg shadow-lg shadow-green-500/20 transition">
                                        <i class="fas fa-play mr-2"></i>OPEN PORTAL
                                    </button>
                                    <button id="btn-close-portal" onclick="toggleAttendancePortal(false)"
                                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white text-xs font-bold rounded-lg shadow-lg shadow-red-500/20 transition hidden">
                                        <i class="fas fa-stop mr-2"></i>CLOSE PORTAL
                                    </button>
                                </div>
                            </div>
                            <!-- Portal Timer/Info (Optional) -->
                            <div id="portal-active-info"
                                class="hidden mb-6 p-4 bg-green-900/10 border border-green-500/20 rounded-xl animate-pulse">
                                <p class="text-green-400 text-sm flex items-center">
                                    <i class="fas fa-broadcast-tower mr-3"></i>
                                    Attendance portal is currently <span class="font-bold underline ml-1">LIVE</span>
                                    for
                                    <span id="active-portal-name" class="ml-1 font-bold">Class</span>. Students can now
                                    verify.
                                </p>
                            </div>
                            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-700">
                                <h3 class="font-bold mb-4">Student Overview</h3>
                                <div class="overflow-hidden rounded-lg">
                                    <table class="w-full text-xs text-left text-gray-400">
                                        <thead class="bg-gray-800 text-gray-500 flex-grow">
                                            <tr>
                                                <th class="p-3">Roll No</th>
                                                <th class="p-3">Student Name</th>
                                                <th class="p-3">Status</th>
                                                <th class="p-3 text-right">Last Seen</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-800">
                                            <tr>
                                                <td colspan="4" class="p-4 text-center italic">Select a class to view
                                                    data</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timetable Tab -->
                <div id="teacher-timetable" class="tab-content-teacher hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-6">Your Teaching Schedule</h2>
                        <div class="grid grid-cols-1 gap-4">
                            <!-- Placeholder Schedule -->
                            <div class="flex items-center p-4 bg-blue-900/20 border border-blue-500/10 rounded-xl">
                                <div class="w-20 text-blue-400 font-bold">MON 09:00</div>
                                <div class="flex-1">
                                    <h4 class="font-bold">Advanced Algorithms</h4>
                                    <p class="text-xs text-gray-500">Lecture Hall 02</p>
                                </div>
                                <span class="text-xs bg-blue-800/40 px-2 py-1 rounded text-blue-200">Upcoming</span>
                            </div>
                            <div class="flex items-center p-4 bg-gray-700/20 border border-gray-600/10 rounded-xl">
                                <div class="w-20 text-gray-400 font-bold">MON 11:00</div>
                                <div class="flex-1">
                                    <h4 class="font-bold">Project Review</h4>
                                    <p class="text-xs text-gray-500">Lab 04</p>
                                </div>
                                <span class="text-xs bg-gray-700/40 px-2 py-1 rounded text-gray-400">Completed</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Material Tab -->
                <div id="teacher-study" class="tab-content-teacher hidden">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-bold mb-6">Study Material Management</h2>
                        <div class="flex space-x-6 mb-6 border-b border-gray-700">
                            <button onclick="showTeacherSection('study','provide')"
                                class="teacher-sub-tab-btn text-green-400 font-semibold border-b-2 border-green-400 pb-2"
                                data-sub="provide">Provide Study Material</button>
                            <button onclick="showTeacherSection('study','history')"
                                class="teacher-sub-tab-btn text-gray-400 hover:text-white font-semibold pb-2"
                                data-sub="history">History of Study Material</button>
                        </div>

                        <div id="teacher-sub-study-provide" class="teacher-sub-content">
                            <div
                                class="max-w-xl mx-auto border-2 border-dashed border-gray-700 rounded-3xl p-10 text-center hover:bg-gray-700/20 transition cursor-pointer group">
                                <i
                                    class="fas fa-file-upload text-5xl text-gray-600 group-hover:text-green-400 mb-4 transition"></i>
                                <h3 class="text-xl font-bold mb-2">Upload New Material</h3>
                                <p class="text-gray-500 text-sm mb-6">Upload PDFs, PPTs, or Notes for your students</p>
                                <button
                                    class="px-6 py-2 bg-green-600 rounded-xl font-bold hover:bg-green-700 transition">Select
                                    Files</button>
                            </div>
                        </div>

                        <div id="teacher-sub-study-history" class="teacher-sub-content hidden">
                            <div class="space-y-3">
                                <div
                                    class="p-4 bg-gray-900/50 rounded-xl border border-gray-800 flex justify-between items-center">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-10 h-10 bg-red-900/20 flex items-center justify-center rounded text-red-400">
                                            <i class="fas fa-file-pdf"></i>
                                        </div>
                                        <div>
                                            <div class="font-bold text-sm">Chapter_1_Algorithms.pdf</div>
                                            <div class="text-[10px] text-gray-500">Uploaded 2 days ago • CS-A</div>
                                        </div>
                                    </div>
                                    <button class="text-gray-400 hover:text-white"><i
                                            class="fas fa-ellipsis-v"></i></button>
                                </div>
                                <div
                                    class="p-4 bg-gray-900/50 rounded-xl border border-gray-800 flex justify-between items-center text-gray-600 italic text-center">
                                    <span class="w-full text-xs">More history records will appear as you upload.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Result Management Section -->
                <div id="teacher-results" class="tab-content-teacher hidden">
                    <div
                        class="bg-gray-800 p-8 rounded-2xl shadow-lg border-2 border-dashed border-gray-700 flex flex-col items-center justify-center text-center py-20">
                        <div class="w-20 h-20 bg-gray-700/50 rounded-full flex items-center justify-center mb-6">
                            <i class="fas fa-award text-4xl text-gray-500"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Result Management Portal</h2>
                        <p class="text-gray-400 max-w-sm mb-8">Process examination results, generate marksheets, and
                            publish grades for your assigned classes.</p>
                        <button
                            class="px-8 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Open
                            Gradebook Navigator</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div id="message-box" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-gray-900 p-8 rounded-2xl shadow-xl max-w-sm w-full text-center space-y-4 border border-gray-700">
            <p id="message-text" class="text-lg text-white"></p>
            <button onclick="hideMessage()"
                class="px-6 py-2 bg-blue-600 text-white rounded-full font-semibold hover:bg-blue-700 transition duration-200">OK</button>
        </div>
    </div>

    <script>
        // ===== Face Recognition System =====
        const videoReg = document.getElementById('video-reg');
        const videoLogin = document.getElementById('video-login');
        const canvasReg = document.getElementById('canvas-reg');
        const canvasLogin = document.getElementById('canvas-login');
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const usernameInput = document.getElementById('username-input');
        const videoAttendance = document.getElementById('video-attendance');
        const canvasAttendance = document.getElementById('canvas-attendance');
        const markAttendanceBtn = document.getElementById('mark-attendance-btn');

        const homeScreen = document.getElementById('home-screen');
        const registerScreen = document.getElementById('register-screen');
        const loginScreen = document.getElementById('login-screen');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const authScreens = document.getElementById('auth-screens');
        const dashboardContent = document.getElementById('dashboard-content');
        const studentAuth = document.getElementById('student-auth');
        const navbar = document.getElementById('navbar');
        const mobileTabs = document.getElementById('mobile-tabs');
        const mainApp = document.getElementById('main-app'); // Added this

        let isVideoRegPlaying = false;
        let isVideoLoginPlaying = false;
        let isVideoAttendancePlaying = false;
        let sentOTP = null;
        let livenessChallenge = []; // Array of tasks e.g. ['smile', 'turn_right', 'move_close']
        let currentTaskIdx = 0;
        let lastTaskTimestamp = 0;
        let isLivenessActive = false;
        let livenessMode = null; // 'register', 'login'
        let pendingRegUsername = '';

        let regInterval, loginInterval, attendanceInterval;
        let registeredUsers = JSON.parse(localStorage.getItem('registeredUsers')) || {};
        let loggedInUser = null;

        // Classroom location
        const CLASSROOM_LOCATION = { lat: 22.681432, lon: 75.879018 };
        const RADIUS_METERS = 50;

        // Utility functions
        const showMessage = (msg) => { messageText.textContent = msg; messageBox.classList.remove('hidden'); };
        const hideMessage = () => { messageBox.classList.add('hidden'); };
        const toggleMainApp = (show) => {
            if (show) {
                authScreens.classList.add('hidden');
                mainApp.classList.remove('hidden');
                navbar.classList.remove('hidden');
                mobileTabs.classList.remove('hidden');
                dashboardContent.classList.remove('hidden');
            } else {
                authScreens.classList.remove('hidden');
                mainApp.classList.add('hidden');
                navbar.classList.add('hidden');
                mobileTabs.classList.add('hidden');
                dashboardContent.classList.add('hidden');
            }
        };

        const goHome = () => {
            stopAllVideo();
            homeScreen.classList.remove('hidden');
            registerScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
        };


        const showRegister = () => {
            homeScreen.classList.add('hidden');
            registerScreen.classList.remove('hidden');
            startVideo(videoReg, canvasReg, 'register');
        };

        const showLogin = () => {
            homeScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            startVideo(videoLogin, canvasLogin, 'login');
        };

        const stopAllVideo = () => {
            [videoReg, videoLogin, videoAttendance].forEach(v => {
                if (v && v.srcObject) {
                    v.srcObject.getTracks().forEach(t => t.stop());
                    v.pause();
                }
            });
            if (regInterval) clearInterval(regInterval);
            if (loginInterval) clearInterval(loginInterval);
            if (attendanceInterval) clearInterval(attendanceInterval);
            isVideoRegPlaying = false;
            isVideoLoginPlaying = false;
            isVideoAttendancePlaying = false;
        };

        // OTP Functions
        window.sendOTP = () => {
            const email = document.getElementById('reg-email').value;
            // Basic regex for validating email
            if (!email || !email.includes('@') || !email.includes('.')) { showMessage("Invalid Email Address"); return; }

            // Simulate OTP
            sentOTP = Math.floor(1000 + Math.random() * 9000).toString();
            console.log("OTP Sent:", sentOTP);
            alert(`[SIMULATION] Your OTP is: ${sentOTP}\n(In production this is sent to ${email})`);

            document.getElementById('email-form').classList.add('hidden');
            document.getElementById('otp-form').classList.remove('hidden');
        };

        window.verifyOTP = () => {
            const input = document.getElementById('reg-otp').value;
            if (input === sentOTP) {
                document.getElementById('reg-step-email').classList.add('hidden');
                document.getElementById('reg-step-face').classList.remove('hidden');
                startVideo(videoReg, canvasReg, 'register');
            } else {
                showMessage("Invalid OTP. Try again.");
            }
        };

        // Liveness Logic
        const TASKS = {
            'smile': { text: "Smile", icon: "fa-smile", check: (d) => d.expressions.happy > 0.7 },
            'surprised': { text: "Look Surprised", icon: "fa-surprise", check: (d) => d.expressions.surprised > 0.6 },
            'neutral': { text: "Straight Face (Neutral)", icon: "fa-meh", check: (d) => d.expressions.neutral > 0.8 },

            'turn_right': {
                text: "Turn Face Left", icon: "fa-arrow-left", check: (d) => {
                    const nose = d.landmarks.positions[30];
                    const boxCenter = d.detection.box.x + d.detection.box.width / 2;
                    return (nose._x - boxCenter) > (d.detection.box.width * 0.15);
                }
            },
            'turn_left': {
                text: "Turn Face Right", icon: "fa-arrow-right", check: (d) => {
                    const nose = d.landmarks.positions[30];
                    const boxCenter = d.detection.box.x + d.detection.box.width / 2;
                    return (boxCenter - nose._x) > (d.detection.box.width * 0.15);
                }
            },

            'tilt_left': {
                text: "Tilt Head Left", icon: "fa-undo", check: (d) => {
                    // Left Eye (36) vs Right Eye (45) - Y coordinates
                    // Tilt Left -> Left Eye (image right) goes DOWN, Right Eye (image left) goes UP ?
                    // No, Tilt Head Left (Ear to shoulder) -> Left Eye (36) is lower Y than Right Eye (45)?
                    // Wait: 36 is Outer Left Eye corner (User's Left). 45 is Outer Right Eye (User's Right).
                    // User Left Tilt: 36 becomes Higher Y (screen coordinates: Y increases downwards). 36.y > 45.y ??
                    // No. Y=0 is TOP.
                    // User tilts head LEFT (Left Ear down). Left Eye (36) Y INCREASES (Goes down). Right Eye (45) Y DECREASES (Goes UP).
                    // So (36.y - 45.y) should be POSITIVE and Large.
                    return (d.landmarks.positions[36]._y - d.landmarks.positions[45]._y) > 15;
                }
            },
            'tilt_right': {
                text: "Tilt Head Right", icon: "fa-redo", check: (d) => {
                    const leftEye = d.landmarks.positions[36];
                    const rightEye = d.landmarks.positions[45];
                    // Right Eye (45) goes DOWN (Y increases). Left Eye (36) goes UP (Y decreases).
                    // So (45.y - 36.y) > 15
                    return (d.landmarks.positions[45]._y - d.landmarks.positions[36]._y) > 15;
                }
            },

            'move_close': {
                text: "Move Closer", icon: "fa-search-plus", check: (d) => {
                    return d.detection.box.width > (canvasReg.width * 0.45) || d.detection.box.width > 200;
                }
            }
        };

        const generateChallenges = () => {
            const keys = Object.keys(TASKS);
            // Shuffle and pick 3
            livenessChallenge = keys.sort(() => 0.5 - Math.random()).slice(0, 3);
            currentTaskIdx = 0;
            lastTaskTimestamp = Date.now();
            isLivenessActive = true;
            updateLivenessUI();
        };

        const updateLivenessUI = () => {
            // Determine IDs based on mode
            const suffix = livenessMode === 'login' ? '-login' : '';
            const overlay = document.getElementById('liveness-overlay' + suffix);
            const icon = document.getElementById('challenge-icon' + suffix);
            const text = document.getElementById('challenge-text' + suffix);
            const sub = document.getElementById('challenge-sub' + suffix);

            if (!overlay) return; // safety

            if (!isLivenessActive) {
                overlay.classList.add('hidden');
                return;
            }

            overlay.classList.remove('hidden');
            const taskKey = livenessChallenge[currentTaskIdx];
            const task = TASKS[taskKey];

            icon.className = `fas ${task.icon} text-6xl text-yellow-400`;
            text.textContent = `Task ${currentTaskIdx + 1}: ${task.text}`;
            text.className = "text-3xl font-bold text-white mb-2 text-center drop-shadow-lg"; // Reset color
            sub.textContent = `Step ${currentTaskIdx + 1} of 3`;
        };

        const processLiveness = (detections) => {
            if (!isLivenessActive) return;

            // Time Check
            if (Date.now() - lastTaskTimestamp > 30000) {
                // Timeout
                showMessage("Session Timed Out! Generating new tasks...");
                generateChallenges();
                return;
            }

            const taskKey = livenessChallenge[currentTaskIdx];
            const passed = TASKS[taskKey].check(detections);

            if (passed) {
                // Task Complete
                currentTaskIdx++;
                lastTaskTimestamp = Date.now(); // Update timestamp for gap check logic

                // Flash Success
                const suffix = livenessMode === 'login' ? '-login' : '';
                const text = document.getElementById('challenge-text' + suffix);
                if (text) {
                    text.textContent = "Great!";
                    text.classList.remove('text-white');
                    text.classList.add('text-green-400');
                }

                if (currentTaskIdx >= livenessChallenge.length) {
                    // ALL DONE
                    isLivenessActive = false;
                    setTimeout(() => {
                        const ov = document.getElementById('liveness-overlay' + suffix);
                        if (ov) ov.classList.add('hidden');
                        completeAction();
                    }, 500);
                } else {
                    // Next Task delay
                    setTimeout(updateLivenessUI, 800);
                }
            }
        };

        const completeAction = () => {
            // Finish Registration or Login
            if (livenessMode === 'register') {
                // Register User
                const username = pendingRegUsername;
                // Get descriptor from LAST frame? Or we need to capture it.
                // We need descriptor. Let's assume the face in view is valid (since liveness passed).
                // We need to recapture one for storage.
                // Or we can just grab it in the next loop?
                // Let's flag a "capture_needed".

                // Simpler: Trigger the registration logic loop ONE last time.
                // Actually, we can assume registeredUsers is global.
                // We need the descriptor.
                // Let's grab it from the current frame? No, processLiveness is inside loop.
                // We will set a flag `finalizeAction = true` and catch it in the loop.
            }
            finalizeAction = true;
        };

        let finalizeAction = false;

        // Haversine distance
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // metres
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // in metres
        }

        // Load face-api models
        const loadModels = async () => {
            loading.classList.remove('hidden');
            document.getElementById('role-selection').classList.add('hidden'); // Hide role select while loading
            try {
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models'),
                    faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
                ]);
                loading.classList.add('hidden');
                // Show role selection instead of student home initially
                document.getElementById('role-selection').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                showMessage("Failed to load face models.");
                loading.classList.add('hidden');
                document.getElementById('role-selection').classList.remove('hidden');
            }
        };

        // Transition from Role Selector to Student Home
        window.enterStudentPortal = function () {
            document.getElementById('role-selection').classList.add('hidden');
            studentAuth.classList.remove('hidden'); // Show parent container
            goHome(); // Ensure home screen is active
        };

        window.backToRoles = function () {
            studentAuth.classList.add('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
            stopAllVideo();
        };

        // Update canvas size
        function updateCanvasSize(video, canvas) {
            if (!video || !canvas) return;
            canvas.width = video.offsetWidth;
            canvas.height = video.offsetHeight;
            faceapi.matchDimensions(canvas, { width: canvas.width, height: canvas.height });
        }

        // Start camera & detect face
        const startVideo = async (video, canvas, mode) => {
            stopAllVideo();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    // Set canvas size after a short delay for rendering
                    setTimeout(() => updateCanvasSize(video, canvas), 200);
                    // Optional: Listen for resize (modern browsers)
                    const resizeObserver = new ResizeObserver(() => updateCanvasSize(video, canvas));
                    resizeObserver.observe(video.parentElement);
                    if (mode === 'register') {
                        isVideoRegPlaying = true;
                        detectFace(video, canvas, mode);
                    } else if (mode === 'login') {
                        isVideoLoginPlaying = true;
                        detectFace(video, canvas, mode);
                    } else if (mode === 'attendance') {
                        isVideoAttendancePlaying = true;
                        detectFace(video, canvas, mode);
                    }
                };
            } catch (err) {
                console.error(err);
                showMessage("Could not access camera.");
            }
        };

        // Detect face
        const detectFace = (video, canvas, mode) => {
            const context = canvas.getContext('2d');
            const interval = setInterval(async () => {
                let isPlaying;
                if (mode === 'register') isPlaying = isVideoRegPlaying;
                else if (mode === 'login') isPlaying = isVideoLoginPlaying;
                else if (mode === 'attendance') isPlaying = isVideoAttendancePlaying;
                if (!isPlaying) {
                    clearInterval(interval);
                    return;
                }
                if (video.paused || video.ended) {
                    clearInterval(interval);
                    return;
                }
                context.clearRect(0, 0, canvas.width, canvas.height);
                const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceExpressions().withFaceDescriptor();
                if (detections) {
                    const resizedDetections = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
                    faceapi.draw.drawDetections(canvas, resizedDetections);
                    faceapi.draw.drawFaceExpressions(canvas, resizedDetections);

                    if (isLivenessActive) {
                        processLiveness(resizedDetections);
                    } else if (finalizeAction) {
                        if (livenessMode === 'register') {
                            finalizeAction = false; // Reset only when we actually process
                            registeredUsers[pendingRegUsername] = {
                                descriptor: Array.from(resizedDetections.descriptor),
                                id: pendingRegUsername + "ID", // Default ID
                                role: 'student',
                                name: pendingRegUsername
                            };
                            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                            showMessage("Identity Verified & Registered!");
                            goHome();
                        } else if (livenessMode === 'login') {
                            // Perform Login Match
                            const labeled = Object.entries(registeredUsers)
                                .filter(([u, data]) => data.descriptor && data.descriptor.length > 0)
                                .map(([u, data]) => new faceapi.LabeledFaceDescriptors(u, [new Float32Array(data.descriptor)]));

                            if (labeled.length === 0) {
                                finalizeAction = false;
                                showMessage("No users in database!");
                                return;
                            }

                            const matcher = new faceapi.FaceMatcher(labeled, 0.6);
                            const bestMatch = matcher.findBestMatch(resizedDetections.descriptor);

                            if (bestMatch.label !== 'unknown' && bestMatch.distance < 0.6) {
                                finalizeAction = false;
                                loggedInUser = {
                                    username: bestMatch.label,
                                    descriptor: registeredUsers[bestMatch.label].descriptor
                                };
                                document.getElementById('nav-username').textContent = bestMatch.label;
                                document.getElementById('sidebar-username').textContent = bestMatch.label;
                                document.getElementById('sidebar-id').textContent = (registeredUsers[bestMatch.label].id || (bestMatch.label + 'ID'));

                                toggleMainApp(true);
                                saveSession(loggedInUser);
                                localStorage.setItem('spark_role', 'student');
                                showMessage("Verified & Logged In!");
                            } else {
                                // Don't reset finalizeAction immediately to allow re-trying for a second?
                                // Actually, let's reset it and show error.
                                finalizeAction = false;
                                showMessage("Face NOT recognized! Try again.");
                                loginBtn.textContent = "Login with Face";
                                loginBtn.disabled = false;
                            }
                        }
                    }

                    // Button enabling logic (only if liveness NOT active)
                    if (!isLivenessActive) {
                        if (mode === 'register') registerBtn.disabled = false;
                        else if (mode === 'login' && Object.keys(registeredUsers).length > 0) loginBtn.disabled = false;
                        else if (mode === 'attendance' && loggedInUser) markAttendanceBtn.disabled = false;
                    }
                } else if (mode === 'register') {
                    registerBtn.disabled = true;
                } else if (mode === 'attendance') {
                    markAttendanceBtn.disabled = true;
                }
            }, 200);
            if (mode === 'register') regInterval = interval;
            else if (mode === 'login') loginInterval = interval;
            else if (mode === 'attendance') attendanceInterval = interval;
        };

        // Handle username input
        usernameInput.addEventListener('input', () => { registerBtn.disabled = usernameInput.value.trim() === ''; });

        // Register button
        // Register button
        // Register button -> Now START LIVENESS
        registerBtn.addEventListener('click', async () => {
            const username = usernameInput.value.trim();
            if (!username) { showMessage("Enter username."); return; }
            if (registeredUsers[username]) { showMessage("Username exists."); return; }

            // Start Challenge
            pendingRegUsername = username;
            livenessMode = 'register';
            generateChallenges();
            // Button is now "Starting..."
            registerBtn.textContent = "Verifying...";
            registerBtn.disabled = true;
        });

        // Login button with location verification
        // Login button -> Start Liveness
        loginBtn.addEventListener('click', async () => {
            if (Object.keys(registeredUsers).length === 0) { showMessage("No users registered."); return; }

            // Check if face is even present first to avoid starting game empty
            const detections = await faceapi.detectSingleFace(videoLogin, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 }));
            if (!detections) { showMessage("Face not detected. Stand in front of camera."); return; }

            livenessMode = 'login';
            generateChallenges();

            // Overlay will be shown by updateLivenessUI using correct suffix
            loginBtn.textContent = "Verifying Liveness...";
            loginBtn.disabled = true;
        });

        // Attendance mark button
        // ===== Attendance Logic with Locking & Logging =====
        let attendanceCheckInterval;

        // Helper: Get Timetable (Fallback to some defaults if empty for demo)
        const getTodayTimetable = () => {
            const stored = localStorage.getItem('spark_timetable_data');
            if (stored) return JSON.parse(stored);

            // Default demo schedule for testing
            return [
                { time: '09:00', startVal: 9, subject: 'Data Structures', teacher: 'Prof. Sharma' },
                { time: '10:00', startVal: 10, subject: 'Algorithms', teacher: 'Prof. Gupta' },
                { time: '14:00', startVal: 14, subject: 'Database Systems', teacher: 'Prof. Ali' },
                { time: '16:00', startVal: 16, subject: 'Machine Learning', teacher: 'Prof. Li' },
                { time: '22:00', startVal: 22, subject: 'Night Study (Demo)', teacher: 'Self' },
                { time: '23:00', startVal: 23, subject: 'Late Night Coding', teacher: 'Self' }
            ];
        };

        // Helper: Get Current Active Class
        const getCurrentClass = () => {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            const timetable = getTodayTimetable();

            // Simple logic: Class starts at 'startVal' hour and lasts 1 hour
            // Adjust parsing if time format is complex. Assuming 24h integer for simplicity of demo or simple string match.
            // Code in 'processTimetableData' usually saves "9:00" etc. 
            // We need robust parsing.

            for (let cls of timetable) {
                let startH = parseInt(cls.time.split(':')[0]);
                if (cls.time.toLowerCase().includes('pm') && startH < 12) startH += 12;
                if (cls.time.toLowerCase().includes('am') && startH === 12) startH = 0;

                // If saved from Excel, it might be just string "09:00".
                // Let's assume standard integer hour matching for robustness in this environment.

                const endH = startH + 1; // 1 hour duration

                if (currentHour >= startH && currentHour < endH) {
                    // Check if minutes matter? standard 00 start.
                    // Calculate exact end time date object
                    const endTime = new Date();
                    endTime.setHours(endH, 0, 0, 0);
                    return { ...cls, endTime: endTime.getTime() };
                }
            }
            return null;
        };

        const updateDashboardStats = () => {
            const log = JSON.parse(localStorage.getItem('spark_attendance_log') || '[]');

            // Filter log for TODAY
            const todayStr = new Date().toDateString();
            const todayLog = log.filter(l => new Date(l.timestamp).toDateString() === todayStr);

            const timetable = getTodayTimetable();
            const totalClasses = timetable.length;

            // Denominator: Total Classes from timetable
            // Numerator: Unique classes attended today
            const attendedClasses = new Set(todayLog.map(l => l.className)).size;

            const statCards = document.getElementById('today-attendance-count');
            if (statCards) statCards.textContent = `${attendedClasses}/${totalClasses}`;
        };

        const renderRecentActivity = () => {
            const list = document.getElementById('recent-activity-list');
            if (!list) return;

            const log = JSON.parse(localStorage.getItem('spark_attendance_log') || '[]');
            // Sort recent first
            const recent = log.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5); // Show last 5

            if (recent.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">No recent activity.</p>';
                return;
            }

            list.innerHTML = recent.map(item => `
                <div class="bg-[#1a1c2e] rounded-xl p-4 border border-gray-800 animate-fade-in">
                    <div class="flex items-center gap-4 py-2">
                        <div class="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center text-green-400">
                            <i class="fas fa-check"></i>
                        </div>
                        <div>
                            <p class="text-white font-medium">Attendance marked</p>
                            <p class="text-sm text-gray-500">${item.className} • ${new Date(item.timestamp).toLocaleTimeString()}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const checkAttendanceLock = () => {
            const lockedUntil = localStorage.getItem('attendance_locked_until');
            const timerContainer = document.getElementById('attendance-timer-container');
            const timerVal = document.getElementById('attendance-countdown');
            const lockMsg = document.getElementById('attendance-lock-msg');
            const btn = document.getElementById('mark-attendance-btn');

            const cameraView = document.getElementById('attendance-camera-view');
            const lockedView = document.getElementById('attendance-locked-view');

            if (!lockedUntil) {
                // Portal Logic Check
                const activePortal = localStorage.getItem('spark_active_attendance_portal');
                const currCls = getCurrentClass();
                const portalMsg = document.getElementById('attendance-portal-message');
                // cameraView is already declared above, no need to redeclare.

                let isPortalOpen = false;
                if (activePortal && currCls && activePortal === currCls.subject) {
                    isPortalOpen = true;
                }

                if (timerContainer) timerContainer.classList.add('hidden');

                if (!isPortalOpen) {
                    if (btn) btn.disabled = true;
                    if (portalMsg) portalMsg.classList.remove('hidden');
                    if (cameraView) cameraView.classList.add('hidden');
                    // Stop video if it was playing
                    if (videoAttendance.srcObject) stopAllVideo();
                } else {
                    if (btn) btn.disabled = false;
                    if (portalMsg) portalMsg.classList.add('hidden');
                    if (cameraView) cameraView.classList.remove('hidden');
                }

                // Locked View always hidden if not timed-locked
                if (lockedView) lockedView.classList.add('hidden');
                return; // Added return here to prevent further execution if not locked
            }

            const now = Date.now();
            const target = parseInt(lockedUntil);

            if (now < target) {
                // Locked
                if (timerContainer) timerContainer.classList.remove('hidden');
                if (btn) btn.disabled = true;

                // Hide Camera, Show Locked View
                if (cameraView) cameraView.classList.add('hidden');
                if (lockedView) lockedView.classList.remove('hidden');

                // Stop video if playing to save resources
                const video = document.getElementById('video-attendance');
                if (video && video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                    video.srcObject = null;
                }

                // Update timer
                const diff = target - now;
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                if (timerVal) timerVal.textContent = `${m}m ${s}s`;

                // Get class name
                const log = JSON.parse(localStorage.getItem('spark_attendance_log') || '[]');
                const last = log[log.length - 1];
                if (last && lockMsg) lockMsg.textContent = `Class in progress: ${last.className}`;

            } else {
                // Unlocked
                localStorage.removeItem('attendance_locked_until');
                if (timerContainer) timerContainer.classList.add('hidden');
                if (btn) btn.disabled = true;

                // Show Camera, Hide Locked View
                if (cameraView) cameraView.classList.remove('hidden');
                if (lockedView) lockedView.classList.add('hidden');

                showMessage("Class completed. Attendance unlocked.");
            }
        };

        // Start checking lock every second
        setInterval(checkAttendanceLock, 1000);

        // Attendance mark button
        markAttendanceBtn.addEventListener('click', async () => {
            if (!loggedInUser) { showMessage("Not logged in."); return; }

            // Check for Active Class
            const currentClass = getCurrentClass();
            // FOR DEMO: If no class matches exactly, we might want to allow it?
            // User requirement: "use time table to check wheater the class it over".
            // If no class is running, we can't mark attendance for "nothing".

            if (!currentClass) {
                // Determine next class for helpful message
                showMessage("No class currently in progress. Check timetable.");
                return;
            }

            // PORTAL CHECK: Double check if teacher has opened the portal
            const activePortal = localStorage.getItem('spark_active_attendance_portal');
            if (!activePortal || activePortal !== currentClass.subject) {
                showMessage("The attendance portal for " + currentClass.subject + " is currently closed by the teacher.");
                return;
            }

            // Face Detection & Liveness
            const detections = await faceapi.detectSingleFace(videoAttendance, new faceapi.TinyFaceDetectorOptions({ inputSize: 320, scoreThreshold: 0.5 })).withFaceLandmarks().withFaceExpressions().withFaceDescriptor();
            if (!detections) { showMessage("Face not detected."); return; }

            // Liveness Check
            if (detections.expressions.happy < 0.5) { showMessage("Liveness Check: Please SMILE to mark attendance!"); return; }

            const distance = faceapi.euclideanDistance(detections.descriptor, loggedInUser.descriptor);

            if (distance >= 0.6) { showMessage("Face does not match logged in user."); return; }

            // Face matched, verify location
            if (!navigator.geolocation) { showMessage("Geolocation not supported."); return; }
            navigator.geolocation.getCurrentPosition(pos => {
                const dist = getDistance(pos.coords.latitude, pos.coords.longitude, CLASSROOM_LOCATION.lat, CLASSROOM_LOCATION.lon);
                // For DEMO purposes, let's be lenient or add a "Skip Location" option if user is testing offline?
                // Assuming user is in the "radius" or we mock it.
                // UNCOMMENT below to enforce radius.
                // if (dist > RADIUS_METERS) { showMessage("Outside classroom ❌"); return; }

                // Mark Attendance
                const logEntry = {
                    timestamp: Date.now(),
                    className: currentClass.subject,
                    status: 'Present',
                    location: 'Verified'
                };

                // Log
                const log = JSON.parse(localStorage.getItem('spark_attendance_log') || '[]');
                log.push(logEntry);
                localStorage.setItem('spark_attendance_log', JSON.stringify(log));

                // Lock
                localStorage.setItem('attendance_locked_until', currentClass.endTime);

                // Update UI
                updateDashboardStats();
                renderRecentActivity();
                checkAttendanceLock(); // Trigger immediately

                showMessage(`Checked in: ${currentClass.subject} ✅`);

            }, err => {
                showMessage("Location permission denied. Attendance not marked.");
            });
        });

        // Logout function
        window.logout = function () {
            loggedInUser = null;
            clearSession();
            toggleMainApp(false);

            // Go back to role selection on logout
            document.getElementById('role-selection').classList.remove('hidden');
            if (studentAuth) studentAuth.classList.add('hidden');

            homeScreen.classList.add('hidden');
            registerScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            stopAllVideo();
        };

        // ===== Dashboard Tab Functionality =====



        // ===== Timetable Day Change (Simple Simulation) =====
        function changeDay(day) {
            document.querySelectorAll('#timetable button').forEach(btn => btn.classList.remove('bg-blue-700', 'text-white'));
            event.target.classList.add('bg-blue-700', 'text-white');
            const dates = {
                'Mon': 'Monday, 18 September 2025',
                'Tue': 'Tuesday, 19 September 2025',
                'Wed': 'Wednesday, 20 September 2025',
                'Thu': 'Thursday, 21 September 2025',
                'Fri': 'Friday, 22 September 2025'
            };
            document.getElementById('currentDate').textContent = dates[day] || 'Monday, 12 June 2023';
            // Simulate content change (static for demo)
            const content = document.getElementById('timetableContent');
            content.innerHTML = `
                <div class="flex items-center p-4 border-l-4 border-blue-500 bg-blue-900 rounded-lg">
                    <div class="w-16 text-blue-200 font-bold">9:00</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">${day} Subject 1</h3>
                        <p class="text-sm text-gray-400">Room 302 • Prof. Sharma</p>
                    </div>
                    <div class="bg-green-800 text-green-200 text-xs px-2 py-1 rounded-full">Completed</div>
                </div>
                <div class="flex items-center p-4 border-l-4 border-blue-500 bg-blue-900 rounded-lg">
                    <div class="w-16 text-blue-200 font-bold">10:00</div>
                    <div class="flex-1">
                        <h3 class="font-semibold">${day} Subject 2</h3>
                        <p class="text-sm text-gray-400">Room 305 • Prof. Gupta</p>
                    </div>
                    <div class="bg-yellow-800 text-yellow-200 text-xs px-2 py-1 rounded-full">In Progress</div>
                </div>
            `;
        }

        // ===== Suggestions Start Buttons =====
        function startSuggestion(type) {
            const links = {
                'algorithms': 'https://leetcode.com/problemset/javascript/',
                'ml': 'https://arxiv.org/list/cs.LG/recent',
                'ds': 'https://www.geeksforgeeks.org/data-structures/',
                'project': 'https://trello.com'
            };
            window.open(links[type] || 'https://example.com', '_blank');
        }

        // ===== Profile Save =====
        document.getElementById('saveProfileBtn').addEventListener('click', () => {
            const profile = {
                name: document.getElementById('profile-name').value,
                id: document.getElementById('profile-id').value,
                email: document.getElementById('profile-email').value,
                course: document.getElementById('profile-course').value,
                goals: document.getElementById('profile-goals').value
            };
            localStorage.setItem('userProfile', JSON.stringify(profile));
            // Update sidebar if logged in
            document.getElementById('sidebar-username').textContent = profile.name;
            document.getElementById('sidebar-id').textContent = profile.id;
            showMessage('Profile saved successfully!');
        });

        // Load profile on init (after login, but for demo)
        const savedProfile = JSON.parse(localStorage.getItem('userProfile'));
        if (savedProfile) {
            document.getElementById('profile-name').value = savedProfile.name || 'Rahul Sharma';
            document.getElementById('profile-id').value = savedProfile.id || 'CS2021BATCH';
            document.getElementById('profile-email').value = savedProfile.email || 'rahul@college.edu';
            document.getElementById('profile-course').value = savedProfile.course || 'Computer Science';
            document.getElementById('profile-goals').value = savedProfile.goals || '';
        }

        // ===== Routine Export =====
        document.getElementById('exportRoutineBtn').addEventListener('click', () => {
            const routineText = `Daily Routine - Monday, 18 September 2025
7:00 - Morning Routine (Completed)
9:00 - Data Structures Class (Completed)
10:00 - Algorithms Class (In Progress)
11:00 - Free Period - Suggested Activity (Upcoming)
12:00 - Lunch Break
14:00 - Database Systems Class (Not Started)
16:00 - Free Time - Suggested Activity (Not Started)`;
            const blob = new Blob([routineText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'daily_routine.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('Routine exported!');
        });

        // ===== Neon Rescheduler System =====
        /* ===== in-memory ===== */
        let classes = []; // each: {id, name, subjects: [{name, teacher, avg}], timetable: [] }
        let absentTeachers = new Set();
        let periodCount = 6;

        /* ===== DOM refs ===== */
        const classesContainer = document.getElementById('classesContainer');
        const addClassBtn = document.getElementById('addClassBtn');
        const resetBtn = document.getElementById('resetBtn');
        const periodCountInput = document.getElementById('periodCount');
        const timetablesInputs = document.getElementById('timetablesInputs');
        const absentTeacherSelect = document.getElementById('absentTeacherSelect');
        const addAbsentBtn = document.getElementById('addAbsentBtn');
        const absentList = document.getElementById('absentList');
        const previewBtn = document.getElementById('previewBtn');
        const regenBtn = document.getElementById('regenBtn');
        const previewArea = document.getElementById('previewArea');

        const resultView = document.getElementById('resultView');
        const resultTablesContainer = document.getElementById('resultTablesContainer');
        const absentBadge = document.getElementById('absentBadge');
        const backBtn = document.getElementById('backBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        /* ===== helpers ===== */
        function uid(prefix = 'id') { return prefix + Math.random().toString(36).slice(2, 9) }
        function clamp(v, min, max) { return Math.max(min, Math.min(max, v)) }
        function escapeHtml(s) { if (s === null || s === undefined) return ''; return ('' + s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) }

        /* ===== Classes CRUD ===== */
        function addClass(initial) {
            const id = uid('c');
            const cls = {
                id,
                name: initial?.name || `Class ${classes.length + 1}`,
                subjects: initial?.subjects || [
                    { name: 'Math', teacher: 'Alice', avg: 50 },
                    { name: 'Science', teacher: 'Bob', avg: 60 }
                ],
                timetable: initial?.timetable || []
            };
            classes.push(cls);
            renderClasses();
            refreshAbsentSelect();
            renderTimetableInputs();
        }

        function removeClass(id) {
            classes = classes.filter(c => c.id !== id);
            renderClasses();
            refreshAbsentSelect();
            renderTimetableInputs();
        }

        function renderClasses() {
            classesContainer.innerHTML = '';
            classes.forEach((c, classIndex) => {
                const card = document.createElement('div');
                card.className = 'class-card';
                card.innerHTML = `
                    <div class="class-title">
                        <div><input class="input" data-bind="name" value="${escapeHtml(c.name)}" /></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn ghost small" data-remove="${c.id}">Remove</button>
                        </div>
                    </div>
                    <div style="margin-top:10px; font-size:13px; color:var(--muted)">Subjects (teacher + avg %). Add/remove subjects below.</div>
                    <div class="subjects" data-subjects-area="${c.id}"></div>
                    <div style="margin-top:8px">
                        <button class="btn ghost" data-add-sub="${c.id}">+ Add Subject</button>
                    </div>
                `;
                classesContainer.appendChild(card);

                // bind name change
                const nameInput = card.querySelector('[data-bind="name"]');
                nameInput.addEventListener('input', (e) => {
                    c.name = e.target.value;
                    renderTimetableInputs();
                    refreshAbsentSelect();
                });

                // remove button
                card.querySelector('[data-remove]').addEventListener('click', () => removeClass(c.id));

                // render subjects area
                const subjectsArea = card.querySelector(`[data-subjects-area="${c.id}"]`);
                function renderSubjects() {
                    subjectsArea.innerHTML = '';
                    c.subjects.forEach((s, idx) => {
                        const chip = document.createElement('div');
                        chip.className = 'subject-chip';
                        chip.innerHTML = `
                            <div style="display:flex; gap:6px; align-items:center; justify-content:space-between;">
                                <div style="text-align:left; min-width:150px;">
                                    <div style="font-weight:700">${escapeHtml(s.name)}</div>
                                    <small>Teacher: <input class="input" data-teacher data-idx="${idx}" value="${escapeHtml(s.teacher)}" style="width:140px"/></small>
                                    <small style="margin-left:8px">Avg: <input class="input" data-avg data-idx="${idx}" value="${escapeHtml(String(s.avg))}" style="width:80px" /></small>
                                </div>
                                <div>
                                    <button class="btn ghost" data-del-sub="${idx}">✕</button>
                                </div>
                            </div>
                        `;
                        subjectsArea.appendChild(chip);

                        // delete subject (uses latest index by re-rendering)
                        chip.querySelector('[data-del-sub]').addEventListener('click', () => {
                            c.subjects.splice(idx, 1);
                            renderClasses();
                            renderTimetableInputs();
                            refreshAbsentSelect();
                        });

                        // update teacher & avg (use dataset idx so handler remains correct on re-render)
                        const teacherInput = chip.querySelector('[data-teacher]');
                        const avgInput = chip.querySelector('[data-avg]');
                        teacherInput.addEventListener('input', (e) => {
                            const i = Number(e.target.dataset.idx);
                            if (!Number.isNaN(i) && c.subjects[i]) {
                                c.subjects[i].teacher = e.target.value;
                                refreshAbsentSelect();
                            }
                        });
                        avgInput.addEventListener('input', (e) => {
                            const i = Number(e.target.dataset.idx);
                            if (!Number.isNaN(i) && c.subjects[i]) {
                                const v = parseFloat(e.target.value);
                                c.subjects[i].avg = Number.isFinite(v) ? clamp(v, 0, 100) : 0;
                            }
                        });
                    });
                }
                renderSubjects();

                // add subject
                card.querySelector('[data-add-sub]').addEventListener('click', () => {
                    c.subjects.push({ name: `Subject ${c.subjects.length + 1}`, teacher: `T${Math.random().toString(36).slice(2, 5)}`, avg: 50 });
                    renderClasses();
                    renderTimetableInputs();
                    refreshAbsentSelect();
                });
            });
        }

        /* ===== Timetable inputs ===== */
        function renderTimetableInputs() {
            periodCount = Math.max(1, parseInt(periodCountInput.value) || 6);
            timetablesInputs.innerHTML = '';
            classes.forEach(c => {
                // ensure timetable length
                if (!Array.isArray(c.timetable) || c.timetable.length !== periodCount) {
                    c.timetable = Array.from({ length: periodCount }, (_, i) => c.subjects[i]?.name || (c.subjects[0] ? c.subjects[0].name : 'Free'));
                }
                const wrapper = document.createElement('div');
                wrapper.style.minWidth = '320px';
                wrapper.innerHTML = `<div style="font-weight:700; margin-bottom:6px">${escapeHtml(c.name)}</div>
                    <textarea class="input" rows="3" data-timearea="${c.id}">${escapeHtml(c.timetable.join(', '))}</textarea>
                    <div style="font-size:12px; color:var(--muted); margin-top:6px">Use subject names exactly (comma separated). Missing subjects will be left 'Free'.</div>`;
                timetablesInputs.appendChild(wrapper);

                const ta = wrapper.querySelector('[data-timearea]');
                ta.addEventListener('change', () => {
                    const arr = ta.value.split(',').map(s => s.trim()).filter(s => s.length > 0);
                    // fill/trim to periodCount
                    while (arr.length < periodCount) arr.push('Free');
                    c.timetable = arr.slice(0, periodCount);
                    ta.value = c.timetable.join(', ');
                });
            });
        }

        /* ===== Absent UI ===== */
        function refreshAbsentSelect() {
            const teachers = new Set();
            classes.forEach(c => c.subjects.forEach(s => {
                const t = (s.teacher || '').trim();
                if (t) teachers.add(t);
            }));
            const names = Array.from(teachers).sort();
            absentTeacherSelect.innerHTML = '';
            names.forEach(n => {
                const opt = document.createElement('option'); opt.value = n; opt.textContent = n;
                absentTeacherSelect.appendChild(opt);
            });
        }

        function renderAbsentList() {
            absentList.innerHTML = '';
            absentTeachers.forEach(t => {
                const pill = document.createElement('div');
                pill.className = 'subject-chip';
                pill.style.display = 'inline-flex';
                pill.style.gap = '8px';
                pill.innerHTML = `<div style="min-width:120px">${escapeHtml(t)}</div><div><button class="btn ghost" data-remove="${escapeHtml(t)}">Remove</button></div>`;
                absentList.appendChild(pill);
                pill.querySelector('[data-remove]').addEventListener('click', () => {
                    absentTeachers.delete(t);
                    renderAbsentList();
                    absentBadge.textContent = `Absent: ${absentTeachers.size}`;
                });
            });
            absentBadge.textContent = `Absent: ${absentTeachers.size}`;
        }

        /* ===== Preview ===== */
        function renderPreview() {
            previewArea.style.display = 'block';
            previewArea.innerHTML = '';
            if (classes.length === 0) {
                previewArea.innerHTML = '<div style="color:var(--muted)">No classes yet.</div>';
                return;
            }
            const tbl = document.createElement('table');
            tbl.className = 'grid';
            const thead = document.createElement('thead'), tbody = document.createElement('tbody');
            const headRow = document.createElement('tr');
            headRow.innerHTML = `<th>Period</th>` + classes.map(c => `<th>${escapeHtml(c.name)}</th>`).join('');
            thead.appendChild(headRow);

            for (let p = 0; p < periodCount; p++) {
                const tr = document.createElement('tr');
                const periodName = `P${p + 1}`;
                const cols = [`<td>${periodName}</td>`];
                classes.forEach(c => {
                    const subj = c.timetable[p] || 'Free';
                    const subjObj = c.subjects.find(s => s.name === subj);
                    const teacher = subjObj ? subjObj.teacher : '';
                    cols.push(`<td>
                        <div>${escapeHtml(subj)}</div>
                        <div class="slot-teacher">${escapeHtml(teacher || '')}</div>
                    </td>`);
                });
                tr.innerHTML = cols.join('');
                tbody.appendChild(tr);
            }
            tbl.appendChild(thead); tbl.appendChild(tbody);
            previewArea.appendChild(tbl);
        }

        /* ===== Rescheduling core algorithm ===== */
        function regenerateScheduleModel() {
            // Build teacher map: teacherName -> {teacher, subjects:Set, pairs:[]}
            const teacherMap = new Map();
            classes.forEach(c => {
                c.subjects.forEach(s => {
                    const t = (s.teacher || '').trim();
                    if (!t) return;
                    if (!teacherMap.has(t)) teacherMap.set(t, { teacher: t, subjects: new Set(), pairs: [] });
                    const entry = teacherMap.get(t);
                    entry.subjects.add(s.name);
                    entry.pairs.push({ classId: c.id, className: c.name, subjectName: s.name });
                });
            });

            // absent set (use local copy for consistency)
            const absentSet = new Set(absentTeachers);

            // prepare new schedules (subjects only)
            const newSchedules = {};
            classes.forEach(c => newSchedules[c.id] = c.timetable.slice());

            // teacher occupied per period
            const teacherOccupiedAt = {}; // teacher -> {period:true}

            for (let p = 0; p < periodCount; p++) {
                // build current assignments
                const assignments = classes.map(c => {
                    const subj = c.timetable[p] || 'Free';
                    const subjObj = c.subjects.find(s => s.name === subj);
                    const teacher = subjObj ? subjObj.teacher : '';
                    const present = teacher ? !absentSet.has(teacher) : true;
                    return { classId: c.id, className: c.name, subj, teacher, present, classObj: c };
                });

                // mark occupied teachers (present original assignments)
                assignments.forEach(a => {
                    if (a.teacher && a.present) {
                        teacherOccupiedAt[a.teacher] = teacherOccupiedAt[a.teacher] || {};
                        teacherOccupiedAt[a.teacher][p] = true;
                    }
                });

                // applicants: slots where assigned teacher is absent
                const applicants = assignments.filter(a => !a.present);

                // also gather free slots (optional fill)
                const freeSlots = assignments.filter(a => a.subj === 'Free');

                // build pool of available teachers (present & not occupied this period)
                const availableTeachers = [];
                teacherMap.forEach(info => {
                    const t = info.teacher;
                    if (absentSet.has(t)) return;
                    if (teacherOccupiedAt[t] && teacherOccupiedAt[t][p]) return;
                    availableTeachers.push({ teacher: t, subjects: Array.from(info.subjects) });
                });

                // helper: best teacher for class (returns {teacher, subject, avg} or null)
                function bestTeacherForClass(classObj) {
                    const candidates = [];
                    availableTeachers.forEach(info => {
                        info.subjects.forEach(subj => {
                            const subObj = classObj.subjects.find(ss => ss.name === subj);
                            const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                            candidates.push({ teacher: info.teacher, subject: subj, avg });
                        });
                    });
                    if (candidates.length === 0) return null;
                    candidates.sort((a, b) => a.avg - b.avg);
                    return candidates[0];
                }

                // compute needs for applicants
                const applicantNeeds = applicants.map(a => {
                    return { applicant: a, best: bestTeacherForClass(a.classObj) };
                });

                // sort applicants by their best.avg ascending (most needy first). nulls go last
                applicantNeeds.sort((A, B) => {
                    const aVal = A.best ? A.best.avg : 1000;
                    const bVal = B.best ? B.best.avg : 1000;
                    return aVal - bVal;
                });

                // assign teachers to applicants
                for (const an of applicantNeeds) {
                    const a = an.applicant;
                    const best = an.best;
                    if (!best) {
                        newSchedules[a.classId][p] = 'Free';
                        continue;
                    }
                    newSchedules[a.classId][p] = best.subject;
                    teacherOccupiedAt[best.teacher] = teacherOccupiedAt[best.teacher] || {};
                    teacherOccupiedAt[best.teacher][p] = true;
                    // remove teacher from available list
                    for (let i = availableTeachers.length - 1; i >= 0; i--) {
                        if (availableTeachers[i].teacher === best.teacher) availableTeachers.splice(i, 1);
                    }
                }

                // try to fill free slots with remaining teachers
                if (availableTeachers.length > 0 && freeSlots.length > 0) {
                    const freeNeeds = freeSlots.map(f => {
                        const classObj = f.classObj;
                        const candidates = [];
                        availableTeachers.forEach(info => {
                            info.subjects.forEach(subj => {
                                const subObj = classObj.subjects.find(ss => ss.name === subj);
                                const avg = subObj ? (Number.isFinite(subObj.avg) ? subObj.avg : 100) : 80;
                                candidates.push({ teacher: info.teacher, subject: subj, avg });
                            });
                        });
                        if (candidates.length === 0) return { free: f, best: null };
                        candidates.sort((a, b) => a.avg - b.avg);
                        return { free: f, best: candidates[0] };
                    });

                    freeNeeds.sort((a, b) => {
                        const av = a.best ? a.best.avg : 1000;
                        const bv = b.best ? b.best.avg : 1000;
                        return av - bv;
                    });

                    for (const fn of freeNeeds) {
                        if (!fn.best) continue;
                        const teacher = fn.best.teacher;
                        const subject = fn.best.subject;
                        newSchedules[fn.free.classId][p] = subject;
                        teacherOccupiedAt[teacher] = teacherOccupiedAt[teacher] || {};
                        teacherOccupiedAt[teacher][p] = true;
                        for (let i = availableTeachers.length - 1; i >= 0; i--) if (availableTeachers[i].teacher === teacher) availableTeachers.splice(i, 1);
                    }
                }

                // any remaining applicants that did not get assignment become Free
                assignments.forEach(a => {
                    if (!a.present && newSchedules[a.classId][p] === a.subj) {
                        newSchedules[a.classId][p] = 'Free';
                    }
                });

            } // end periods

            // convert newSchedules to result structure including chosen teacher name (prefer class's own teacher if available)
            const result = classes.map(c => {
                const arr = newSchedules[c.id].slice();
                const finalArr = arr.map(subj => {
                    if (subj === 'Free') return { subject: 'Free', teacher: '' };
                    // try find the teacher in same class subjects
                    const sObj = c.subjects.find(s => s.name === subj);
                    if (sObj && !absentTeachers.has(sObj.teacher)) return { subject: subj, teacher: sObj.teacher };
                    // otherwise pick any teacher (non-absent) from teacherMap that teaches subj
                    let teacher = '';
                    for (let [t, info] of teacherMap) {
                        if (absentTeachers.has(t)) continue;
                        if (info.subjects.has(subj)) {
                            teacher = t; break;
                        }
                    }
                    return { subject: subj, teacher };
                });
                return { classId: c.id, className: c.name, schedule: finalArr };
            });

            return { result, absentList: Array.from(absentTeachers) };
        }

        /* ===== UI wiring ===== */
        addClassBtn.addEventListener('click', () => addClass());
        resetBtn.addEventListener('click', () => {
            if (!confirm('Reset all classes and inputs?')) return;
            classes = [];
            absentTeachers.clear();
            addClass({ name: 'Class 1' });
            addClass({ name: 'Class 2' });
            renderClasses();
            renderTimetableInputs();
            refreshAbsentSelect();
            renderAbsentList();
            previewArea.style.display = 'none';
        });

        periodCountInput.addEventListener('change', () => renderTimetableInputs());

        addAbsentBtn.addEventListener('click', () => {
            const t = absentTeacherSelect.value;
            if (!t) return;
            absentTeachers.add(t);
            renderAbsentList();
        });

        previewBtn.addEventListener('click', () => renderPreview());

        regenBtn.addEventListener('click', () => {
            if (classes.length === 0) { alert('Add at least one class.'); return; }
            const model = regenerateScheduleModel();
            showResult(model);
        });

        // seed data
        addClass({
            name: 'Computer Science A', subjects: [
                { name: 'Math', teacher: 'Alice', avg: 45 },
                { name: 'Algorithms', teacher: 'Eve', avg: 40 },
                { name: 'Databases', teacher: 'Bob', avg: 65 },
            ], timetable: ['Math', 'Algorithms', 'Databases', 'Math', 'Algorithms', 'Free']
        });
        addClass({
            name: 'Computer Science B', subjects: [
                { name: 'Math', teacher: 'Carol', avg: 70 },
                { name: 'Algorithms', teacher: 'Dave', avg: 55 },
                { name: 'Databases', teacher: 'Bob', avg: 60 },
            ], timetable: ['Algorithms', 'Math', 'Databases', 'Math', 'Free', 'Databases']
        });

        refreshAbsentSelect();
        renderAbsentList();
        renderTimetableInputs();

        /* Result rendering */
        function showResult(model) {
            resultView.style.display = 'block';
            absentBadge.textContent = `Absent: ${model.absentList.length}`;
            resultTablesContainer.innerHTML = '';

            const legend = document.createElement('div');
            legend.style.marginBottom = '10px';
            legend.innerHTML = `<div style="color:var(--muted); font-size:13px">Legend: <strong style="color:#fff">Subject</strong> • <span style="color:var(--muted)">Teacher</span></div>`;
            resultTablesContainer.appendChild(legend);

            const { result } = model;
            const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);

            const bigTable = document.createElement('table'); bigTable.className = 'grid';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = `<th>Period</th>` + result.map(r => `<th>${escapeHtml(r.className)}</th>`).join('');
            thead.appendChild(headerRow);
            bigTable.appendChild(thead);

            const tbody = document.createElement('tbody');
            for (let p = 0; p < periodCount; p++) {
                const tr = document.createElement('tr');
                const periodName = periodLabels[p];
                let cols = `<td>${periodName}</td>`;
                result.forEach(r => {
                    const cell = r.schedule[p];
                    const subject = escapeHtml(cell.subject);
                    const teacher = escapeHtml(cell.teacher);
                    cols += `<td>
                        <div style="font-weight:700; color: white">${subject === 'Free' ? '<span style="color:var(--muted)">Free</span>' : subject}</div>
                        <div style="font-size:12px; color:var(--muted); margin-top:6px">${teacher || ''}</div>
                    </td>`;
                });
                tr.innerHTML = cols;
                tbody.appendChild(tr);
            }
            bigTable.appendChild(tbody);
            resultTablesContainer.appendChild(bigTable);
        }

        backBtn.addEventListener('click', () => {
            resultView.style.display = 'none';
        });

        downloadBtn.addEventListener('click', () => {
            const model = regenerateScheduleModel();
            const res = model.result;
            const headers = ['Period', ...res.map(r => r.className)];
            const periodLabels = Array.from({ length: periodCount }, (_, i) => `P${i + 1}`);
            let rows = [headers.join(',')];
            for (let p = 0; p < periodCount; p++) {
                const row = [periodLabels[p]];
                for (const r of res) {
                    const s = r.schedule[p];
                    const cell = s.subject + (s.teacher ? ` (${s.teacher})` : '');
                    row.push('"' + cell.replace(/"/g, '""') + '"');
                }
                rows.push(row.join(','));
            }
            const csv = rows.join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'regenerated_timetable.csv'; document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        // Initialize the application
        // ===== TIMETABLE UPLOAD & EDIT FEATURE =====
        const timetableBody = document.getElementById('timetable-body');
        const timetableContainer = document.getElementById('timetable-container');
        const timetableEmpty = document.getElementById('timetable-empty');

        function getTimetableKey() {
            const u = loggedInUser ? loggedInUser.username : 'default';
            return `timetable_${u}`;
        }

        window.handleTimetableUpload = async function (input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();

            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processTimetableData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.pdf')) {
                reader.onload = async (e) => {
                    const typedarray = new Uint8Array(e.target.result);
                    try {
                        const loadingTask = pdfjsLib.getDocument(typedarray);
                        const pdf = await loadingTask.promise;
                        let allRows = [];

                        // Extract text from all pages
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            // Naive text extraction: join items with space
                            // A better table extration would require checking Y coordinates
                            // For this specific format (Teacher, Subject, Time) we assume they appear in order
                            const strings = textContent.items.map(item => item.str);

                            // Try to chunk by 3 if logical
                            // This is highly dependent on PDF structure. 
                            // We'll treat every 3 non-empty strings as a row as a fallback
                            const nonEmpty = strings.filter(s => s.trim().length > 0);
                            for (let j = 0; j < nonEmpty.length; j += 3) {
                                if (j + 2 < nonEmpty.length) {
                                    allRows.push([nonEmpty[j], nonEmpty[j + 1], nonEmpty[j + 2]]);
                                }
                            }
                        }

                        if (allRows.length === 0) {
                            alert("Could not extract structured data from PDF. Please enter manually.");
                            timetableEmpty.classList.add('hidden');
                            timetableContainer.classList.remove('hidden');
                            addTimetableRow();
                        } else {
                            processTimetableData(allRows);
                        }
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing PDF. Try Excel for better results.");
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        };

        function processTimetableData(rows) {
            if (!rows || rows.length === 0) return;

            // Separate headers from data
            // We assume the first row contains headers as requested
            let headers = [];
            let dataRows = [];

            if (rows.length > 0) {
                headers = rows[0].map(h => String(h).toLowerCase().trim());
                dataRows = rows.slice(1); // Skip the first row
            }

            // Default mapping based on "Teacher, Subject, Time" assumption
            let tIdx = 0;   // Teacher
            let sIdx = 1;   // Subject
            let timeIdx = 2; // Time

            // Attempt to dynamically find columns if headers exist
            if (headers.length > 0) {
                const findIdx = (keywords) => headers.findIndex(h => keywords.some(k => h.includes(k)));

                const foundT = findIdx(['teacher', 'prof', 'faculty', 'name', 'instructor']);
                const foundS = findIdx(['subject', 'course', 'class', 'module']);
                const foundTime = findIdx(['time', 'timing', 'slot', 'lecture', 'period']);

                // Update indices only if found. 
                // We trust the finding logic, but fallback to 0,1,2 if headers are completely ambiguous
                if (foundT !== -1) tIdx = foundT;
                if (foundS !== -1) sIdx = foundS;
                if (foundTime !== -1) timeIdx = foundTime;
            }

            const cleanRows = [];

            dataRows.forEach(row => {
                if (!Array.isArray(row) || row.length === 0) return;

                // Extract data using the mapped indices
                // Handle cases where row might be shorter than expected
                let teacher = row[tIdx] !== undefined ? row[tIdx] : '';
                let subject = row[sIdx] !== undefined ? row[sIdx] : '';
                let time = row[timeIdx] !== undefined ? row[timeIdx] : '';

                // Clean up string values
                teacher = String(teacher).trim();
                subject = String(subject).trim();
                time = String(time).trim();

                // Skip completely empty rows
                if (!teacher && !subject && !time) return;

                cleanRows.push({ time, subject, teacher });
            });

            if (cleanRows.length === 0) {
                showMessage("No valid data rows found after skipping headers.");
                return;
            }

            renderTimetable(cleanRows);
            timetableEmpty.classList.add('hidden');
            timetableContainer.classList.remove('hidden');
            showMessage(`Imported ${cleanRows.length} classes (Headers skipped).`);
        }

        function renderTimetable(data) {
            timetableBody.innerHTML = '';
            data.forEach(row => {
                addTimetableRow(row.time, row.subject, row.teacher);
            });
            if (data.length === 0) addTimetableRow();
        }

        window.addTimetableRow = function (time = '', subject = '', teacher = '') {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-800/50 transition-colors group';
            tr.innerHTML = `
                <td class="p-3"><input type="text" value="${escapeHtml(time)}" placeholder="9:00 AM" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3"><input type="text" value="${escapeHtml(subject)}" placeholder="Subject" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3"><input type="text" value="${escapeHtml(teacher)}" placeholder="Prof. Name" class="w-full bg-transparent border border-gray-700 rounded px-2 py-1 text-white focus:border-blue-500 outline-none"></td>
                <td class="p-3 text-right">
                    <button onclick="this.closest('tr').remove()" class="text-red-400 hover:text-red-300 opacity-0 group-hover:opacity-100 transition-opacity p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
             `;
            timetableBody.appendChild(tr);
        };

        window.saveTimetableComp = function (data = null) {
            let saveData = data;
            if (!saveData) {
                saveData = [];
                timetableBody.querySelectorAll('tr').forEach(tr => {
                    const inputs = tr.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        saveData.push({
                            time: inputs[0].value,
                            subject: inputs[1].value,
                            teacher: inputs[2].value
                        });
                    }
                });
            }
            if (loggedInUser) {
                localStorage.setItem(getTimetableKey(), JSON.stringify(saveData));
                showMessage("Timetable saved for " + loggedInUser.username + "!");
            } else {
                showMessage("Please log in to save permanently.");
            }

            if (saveData.length > 0) {
                timetableEmpty.classList.add('hidden');
                timetableContainer.classList.remove('hidden');
            }
        };

        function loadCompTimetable() {
            if (!loggedInUser) return;
            const key = getTimetableKey();
            const stored = localStorage.getItem(key);
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    if (Array.isArray(data) && data.length > 0) {
                        timetableEmpty.classList.add('hidden');
                        timetableContainer.classList.remove('hidden');
                        renderTimetable(data);
                    } else {
                        timetableEmpty.classList.remove('hidden');
                        timetableContainer.classList.add('hidden');
                    }
                } catch (e) { console.error(e); }
            } else {
                timetableEmpty.classList.remove('hidden');
                timetableContainer.classList.add('hidden');
            }
        }

        // ===== Dashboard Tab Functionality =====
        let currentTab = 'dashboard-home';

        // Clock functionality
        function updateClock() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            const dateEl = document.getElementById('current-date-display');
            const timeEl = document.getElementById('current-time-display');

            if (dateEl) dateEl.textContent = dateStr;
            if (timeEl) timeEl.textContent = timeStr;
        }
        setInterval(updateClock, 1000);
        updateClock();

        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                if (tabId !== currentTab) {
                    if (currentTab === 'attendance') {
                        if (videoAttendance.srcObject) {
                            videoAttendance.srcObject.getTracks().forEach(t => t.stop());
                            videoAttendance.pause();
                        }
                        if (attendanceInterval) clearInterval(attendanceInterval);
                        isVideoAttendancePlaying = false;
                        markAttendanceBtn.disabled = true;
                    }
                    currentTab = tabId;
                    localStorage.setItem('spark_current_tab', currentTab); // Save tab state
                }

                // Deactivate all tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.classList.contains('text-blue-400')) {
                        btn.classList.remove('text-blue-400', 'bg-blue-900/50', 'border', 'border-blue-500/20');
                    }
                    btn.classList.add('text-gray-400');
                    // Reset mobile/desktop specific styles
                    btn.classList.remove('bg-blue-900', 'border-b-2', 'border-blue-400');
                });

                // Activate clicked tab
                if (button.classList.contains('text-gray-400')) {
                    button.classList.remove('text-gray-400');
                }
                button.classList.add('text-blue-400');

                // For mobile tabs with border
                if (button.classList.contains('border-b-2') || button.parentElement.classList.contains('overflow-x-auto')) {
                    // Basic check for mobile nav
                    button.classList.add('border-b-2', 'border-blue-400');
                } else {
                    // Desktop sidebar style
                    button.classList.add('bg-blue-900/50', 'border', 'border-blue-500/20');
                }

                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                // Show selected tab content
                const targetContent = document.getElementById(tabId);
                if (targetContent) targetContent.classList.add('active');

                if (tabId === 'attendance' && loggedInUser) {
                    startVideo(videoAttendance, canvasAttendance, 'attendance');
                }
            });
        });

        // ===== Session Persistence & Tab State =====
        const saveSession = (user) => {
            localStorage.setItem('spark_session_user', JSON.stringify(user));
        };

        const clearSession = () => {
            localStorage.removeItem('spark_session_user');
            localStorage.removeItem('spark_current_tab');
            localStorage.removeItem('spark_role');
            localStorage.removeItem('spark_admin_active');
        };

        const restoreSession = () => {
            // Restore Role First
            const isAdminActive = localStorage.getItem('spark_admin_active') === 'true';
            if (isAdminActive) {
                enterAdminPortal();
                const savedAdminTab = localStorage.getItem('spark_admin_tab') || 'admin-data';
                const tabBtn = document.querySelector(`.tab-btn-admin[data-tab="${savedAdminTab}"]`);
                if (tabBtn) tabBtn.click();
                return;
            }

            const isTeacherActive = localStorage.getItem('spark_teacher_active') === 'true';
            if (isTeacherActive) {
                enterTeacherPortal();
                const savedTeacherTab = localStorage.getItem('spark_teacher_tab') || 'teacher-attendance';
                const tabBtn = document.querySelector(`.tab-btn-teacher[data-tab="${savedTeacherTab}"]`);
                if (tabBtn) tabBtn.click();
                return;
            }

            const savedUser = localStorage.getItem('spark_session_user');
            if (savedUser) {
                try {
                    loggedInUser = JSON.parse(savedUser);
                    // Update UI
                    document.getElementById('nav-username').textContent = loggedInUser.username;
                    document.getElementById('sidebar-username').textContent = loggedInUser.username;
                    const uData = registeredUsers[loggedInUser.username] || {};
                    document.getElementById('sidebar-id').textContent = uData.id || (loggedInUser.username + 'ID');

                    // Show Main App
                    toggleMainApp(true);

                    // Restore Tab
                    const savedTab = localStorage.getItem('spark_current_tab') || 'dashboard-home';
                    const tabBtn = document.querySelector(`.tab-btn[data-tab="${savedTab}"]`);
                    if (tabBtn) tabBtn.click();

                    // Initialize Data
                    updateDashboardStats();
                    renderRecentActivity();
                    checkAttendanceLock();
                    loadCompTimetable();

                } catch (e) {
                    console.error("Session restore failed", e);
                    clearSession();
                }
            } else {
                toggleMainApp(false);
                document.getElementById('role-selection').classList.remove('hidden');
                if (studentAuth) studentAuth.classList.add('hidden');
            }
        };

        // Generic Form Persistence
        const saveFormState = () => {
            const inputs = document.querySelectorAll('input, select, textarea');
            const data = {};
            inputs.forEach(input => {
                if (input.id) data[input.id] = input.value;
            });
            localStorage.setItem('spark_form_data', JSON.stringify(data));
        };

        const restoreFormState = () => {
            const saved = localStorage.getItem('spark_form_data');
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(data).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = data[id];
                });
            }
        };

        document.addEventListener('input', saveFormState);
        document.addEventListener('change', saveFormState);

        // Update login logic to save session
        const originalLoginHandler = loginBtn.onclick; // We don't have direct access to the anonymous function from addEventListener
        // Since we added event listener using addEventListener, we can't overwrite it easily unless we refactor.
        // Instead, we will inject the saveSession call inside the existing loginBtn click handler logic.
        // Wait, I can't inject into the previous function without replacing it.
        // I should have edited the loginBtn handler in the previous step. 
        // I will rely on the user refreshing the page to pick up the new logic if I edit the login handler in the next step.
        // But for now, let's put the restore logic in 'load'.

        // ===== TEACHER PORTAL LOGIC =====
        const teacherDashboard = document.getElementById('teacher-dashboard');

        window.toggleAttendancePortal = function (isOpen) {
            const classSelect = document.getElementById('teacher-portal-class-select');
            const selectedClass = classSelect.value;
            const badge = document.getElementById('attendance-portal-status-badge');
            const btnOpen = document.getElementById('btn-open-portal');
            const btnClose = document.getElementById('btn-close-portal');
            const info = document.getElementById('portal-active-info');
            const infoName = document.getElementById('active-portal-name');

            if (isOpen) {
                localStorage.setItem('spark_active_attendance_portal', selectedClass);
                badge.textContent = "OPEN";
                badge.classList.remove('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                badge.classList.add('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                btnOpen.classList.add('hidden');
                btnClose.classList.remove('hidden');
                info.classList.remove('hidden');
                infoName.textContent = selectedClass;
                showMessage(`Attendance portal opened for ${selectedClass}`);
            } else {
                localStorage.removeItem('spark_active_attendance_portal');
                badge.textContent = "CLOSED";
                badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                btnOpen.classList.remove('hidden');
                btnClose.classList.add('hidden');
                info.classList.add('hidden');
                showMessage("Attendance portal closed.");
            }
        };

        // Sync Portal UI on load/tab switch
        function syncTeacherPortalUI() {
            const active = localStorage.getItem('spark_active_attendance_portal');
            const badge = document.getElementById('attendance-portal-status-badge');
            const btnOpen = document.getElementById('btn-open-portal');
            const btnClose = document.getElementById('btn-close-portal');
            const info = document.getElementById('portal-active-info');
            const infoName = document.getElementById('active-portal-name');
            const classSelect = document.getElementById('teacher-portal-class-select');

            if (active) {
                // If the selected class matches the active portal, show OPEN
                if (classSelect && classSelect.value === active) {
                    if (badge) {
                        badge.textContent = "OPEN";
                        badge.classList.remove('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                        badge.classList.add('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                    }
                    if (btnOpen) btnOpen.classList.add('hidden');
                    if (btnClose) btnClose.classList.remove('hidden');
                    if (info) info.classList.remove('hidden');
                    if (infoName) infoName.textContent = active;
                } else {
                    // Portal is open for a DIFFERENT class
                    if (badge) {
                        badge.textContent = "CLOSED (Active for " + active + ")";
                        badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                        badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                    }
                    if (btnOpen) btnOpen.classList.remove('hidden');
                    if (btnClose) btnClose.classList.add('hidden');
                    if (info) info.classList.remove('hidden');
                    if (infoName) infoName.textContent = active;
                }
            } else {
                if (badge) {
                    badge.textContent = "CLOSED";
                    badge.classList.add('bg-red-900/40', 'text-red-400', 'border-red-900/50');
                    badge.classList.remove('bg-green-900/40', 'text-green-400', 'border-green-900/50');
                }
                if (btnOpen) btnOpen.classList.remove('hidden');
                if (btnClose) btnClose.classList.add('hidden');
                if (info) info.classList.add('hidden');
            }
        }

        // Add listener for class select
        document.getElementById('teacher-portal-class-select').addEventListener('change', syncTeacherPortalUI);

        window.enterTeacherPortal = function () {
            localStorage.setItem('spark_teacher_active', 'true');
            // Hide Auth Screens
            document.getElementById('auth-screens').classList.add('hidden');

            // Hide everything else
            if (navbar) navbar.classList.add('hidden');
            if (mobileTabs) mobileTabs.classList.add('hidden');
            if (mainApp) mainApp.classList.add('hidden');
            if (adminDashboard) adminDashboard.classList.add('hidden');

            // Show Teacher Dashboard
            if (teacherDashboard) teacherDashboard.classList.remove('hidden');
            syncTeacherPortalUI();
        };

        window.logoutTeacher = function () {
            localStorage.removeItem('spark_teacher_active');
            if (teacherDashboard) teacherDashboard.classList.add('hidden');

            // Restore Auth Selection
            const authScreens = document.getElementById('auth-screens');
            authScreens.classList.remove('hidden');
            document.getElementById('role-selection').classList.remove('hidden');
        };

        // Teacher Tab Switching
        document.querySelectorAll('.tab-btn-teacher').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                localStorage.setItem('spark_teacher_tab', tabId);

                // Active Button State
                document.querySelectorAll('.tab-btn-teacher').forEach(b => {
                    b.classList.remove('text-green-400', 'bg-green-900/50', 'border', 'border-green-500/20');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('text-green-400', 'bg-green-900/50', 'border', 'border-green-500/20');
                btn.classList.remove('text-gray-400');

                // Show Content
                document.querySelectorAll('.tab-content-teacher').forEach(c => c.classList.add('hidden'));
                const target = document.getElementById(tabId);
                if (target) target.classList.remove('hidden');
            });
        });

        // Teacher Sub-section Switching
        window.showTeacherSection = function (main, sub) {
            // Find the sub-tab buttons for this main section
            const parent = document.getElementById('teacher-' + main);
            parent.querySelectorAll('.teacher-sub-tab-btn').forEach(b => {
                b.classList.remove('text-green-400', 'border-b-2', 'border-green-400');
                b.classList.add('text-gray-400');
                if (b.dataset.sub === sub) {
                    b.classList.add('text-green-400', 'border-b-2', 'border-green-400');
                    b.classList.remove('text-gray-400');
                }
            });

            // Show the sub-content
            parent.querySelectorAll('.teacher-sub-content').forEach(c => c.classList.add('hidden'));
            const subContent = document.getElementById('teacher-sub-' + main + '-' + sub);
            if (subContent) subContent.classList.remove('hidden');
        };

        // ===== ADMIN PORTAL LOGIC =====
        const adminDashboard = document.getElementById('admin-dashboard');

        window.enterAdminPortal = function () {
            localStorage.setItem('spark_admin_active', 'true');
            // Hide Auth Screens Container completely
            document.getElementById('auth-screens').classList.add('hidden');

            // Hide Student Main App elements to be safe
            if (navbar) navbar.classList.add('hidden');
            if (mobileTabs) mobileTabs.classList.add('hidden');
            if (mainApp) mainApp.classList.add('hidden');

            // Show Admin Dashboard
            if (adminDashboard) adminDashboard.classList.remove('hidden');
            renderAdminAttendance();
        };

        window.logoutAdmin = function () {
            localStorage.removeItem('spark_admin_active');
            if (adminDashboard) adminDashboard.classList.add('hidden');

            // Restore Auth Screens
            const authScreens = document.getElementById('auth-screens');
            authScreens.classList.remove('hidden');

            document.getElementById('role-selection').classList.remove('hidden');
            if (studentAuth) studentAuth.classList.add('hidden');
        };

        // Admin Tab Switching
        document.querySelectorAll('.tab-btn-admin').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.dataset.tab;
                localStorage.setItem('spark_admin_tab', tabId);

                // Active Button State
                document.querySelectorAll('.tab-btn-admin').forEach(b => {
                    b.classList.remove('text-purple-400', 'bg-purple-900/50', 'border', 'border-purple-500/20');
                    b.classList.add('text-gray-400');
                });
                btn.classList.add('text-purple-400', 'bg-purple-900/50', 'border', 'border-purple-500/20');
                btn.classList.remove('text-gray-400');

                // Show Content
                document.querySelectorAll('.tab-content-admin').forEach(c => c.classList.add('hidden'));
                const target = document.getElementById(tabId);
                if (target) target.classList.remove('hidden');

                if (tabId === 'admin-attendance') renderAdminAttendance();
            });
        });

        // Admin Sub-section Switching (Add/Remove/Modify)
        window.showAdminSection = function (sub) {
            document.querySelectorAll('.sub-tab-btn').forEach(b => {
                b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                b.classList.add('text-gray-400');
                if (b.dataset.sub === sub) {
                    b.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                    b.classList.remove('text-gray-400');
                }
            });

            document.querySelectorAll('.admin-sub-content').forEach(c => c.classList.add('hidden'));
            const subContent = document.getElementById('admin-sub-' + sub);
            if (subContent) subContent.classList.remove('hidden');

            if (sub === 'remove' || sub === 'modify') {
                renderAdminUserTable(); // Populate lists
            }
        };

        // User Management
        window.adminAddUserManual = function () {
            const name = document.getElementById('admin-add-name').value;
            const id = document.getElementById('admin-add-id').value;
            const role = document.getElementById('admin-add-role').value;

            if (!name || !id) { showMessage("Please enter Name and ID"); return; }

            if (registeredUsers[name] || registeredUsers[id]) {
                showMessage("User already exists!");
                return;
            }

            registeredUsers[name] = {
                descriptor: [],
                id: id,
                role: role,
                name: name
            };
            localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
            showMessage(`User ${name} added successfully!`);

            document.getElementById('admin-add-name').value = '';
            document.getElementById('admin-add-id').value = '';
        };

        window.handleAdminFileUpload = function (input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('admin-upload-status');
            status.textContent = "Processing " + file.name + "...";

            setTimeout(() => {
                status.textContent = "Imported 24 users from " + file.name;
                status.classList.add('text-green-400');
                showMessage("Import Successful! (Simulation)");
            }, 1500);
        };

        window.renderAdminUserTable = function () {
            const tbody = document.getElementById('admin-user-table-body');
            const removeList = document.getElementById('admin-remove-list');
            if (tbody) tbody.innerHTML = '';
            if (removeList) removeList.innerHTML = '<div class="text-gray-500 text-center py-4">Search to find users to remove</div>';

            const filterRole = document.getElementById('admin-filter-role')?.value || 'all';
            const filterSearch = document.getElementById('admin-filter-search')?.value.toLowerCase() || '';
            const removeSearch = document.getElementById('admin-search-remove')?.value.toLowerCase() || '';

            Object.keys(registeredUsers).forEach(key => {
                const user = registeredUsers[key];
                const name = user.name || key;
                const id = user.id || 'N/A';
                const role = user.role || 'student';

                // Filter Monitor
                if (tbody) {
                    let match = true;
                    if (filterRole !== 'all' && role !== filterRole) match = false;
                    if (filterSearch && !name.toLowerCase().includes(filterSearch) && !id.toLowerCase().includes(filterSearch)) match = false;

                    if (match) {
                        const row = `
                            <tr class="hover:bg-gray-700/50 transition border-b border-gray-800">
                                <td class="p-4 font-medium">${name}</td>
                                <td class="p-4 text-gray-400">${id}</td>
                                <td class="p-4"><span class="px-2 py-1 rounded text-xs bg-gray-700 border border-gray-600 uppercase">${role}</span></td>
                                <td class="p-4 text-right">
                                    <button class="text-blue-400 hover:text-blue-300 mr-2" onclick="alert('Edit implementation pending')"><i class="fas fa-edit"></i></button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    }
                }
            });

            // Render Remove List
            if (removeSearch && removeList) {
                removeList.innerHTML = '';
                Object.keys(registeredUsers).forEach(key => {
                    const user = registeredUsers[key];
                    const name = user.name || key;
                    const id = user.id || 'N/A';

                    if (!name.toLowerCase().includes(removeSearch) && !id.toLowerCase().includes(removeSearch)) return;

                    const item = `
                        <div class="flex justify-between items-center bg-gray-700/30 p-3 rounded-lg border border-gray-700 hover:bg-red-900/10 transition">
                             <div>
                                <div class="font-bold text-white">${name}</div>
                                <div class="text-xs text-gray-500">${id}</div>
                             </div>
                             <button onclick="adminRemoveUser('${key}')" class="text-red-400 hover:text-red-300 p-2"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    removeList.innerHTML += item;
                });
            }
        };

        window.adminRemoveUser = function (key) {
            if (confirm('Are you sure you want to remove this user?')) {
                delete registeredUsers[key];
                localStorage.setItem('registeredUsers', JSON.stringify(registeredUsers));
                renderAdminUserTable();
                showMessage("User removed.");
            }
        };

        // Attendance Aggregation
        window.renderAdminAttendance = function () {
            const log = JSON.parse(localStorage.getItem('spark_attendance_log') || '[]');
            const tbody = document.getElementById('admin-attendance-log-body');
            const totalCountDisplay = document.getElementById('admin-total-checkins');

            if (totalCountDisplay) totalCountDisplay.textContent = log.length;

            if (tbody) {
                tbody.innerHTML = '';
                const recent = log.sort((a, b) => b.timestamp - a.timestamp).slice(0, 50);

                recent.forEach(entry => {
                    const date = new Date(entry.timestamp);
                    const row = `
                        <tr class="hover:bg-gray-700/50 transition border-b border-gray-800">
                            <td class="p-4 text-gray-400">${date.toLocaleTimeString()}</td>
                            <td class="p-4 font-medium text-white">${entry.className}</td>
                            <td class="p-4 text-green-400"><i class="fas fa-check-circle mr-2"></i>Present</td> 
                            <td class="p-4 text-right">
                                <button class="text-gray-500 hover:text-white"><i class="fas fa-ellipsis-h"></i></button>
                            </td>
                        </tr>
                     `;
                    tbody.innerHTML += row;
                });
            }
        };

        window.addEventListener('load', () => {
            restoreSession();
            restoreFormState();
            loadModels();
        });
    </script>

    <!-- Gemini Chat Widget -->
    <div id="gemini-chat-widget" class="gemini-chat-widget" style="display: none; flex-direction: column;">
        <div class="gemini-chat-header">
            <div class="gemini-icon">
                <i class="fas fa-robot text-slate-900"></i>
            </div>
            <h3>SmartClass AI Assistant</h3>
        </div>
        <div id="gemini-messages" class="gemini-chat-messages">
            <div class="gemini-message assistant">👋 Hi! I'm your spark AI. How can I help you today?</div>
        </div>
        <div class="gemini-chat-input-container">
            <input type="text" id="gemini-input" class="gemini-chat-input" placeholder="Type your message..." />
            <button id="gemini-send" class="gemini-send-btn">Send</button>
        </div>
    </div>

    <button id="gemini-toggle" class="gemini-toggle-btn">
        <i class="fas fa-robot text-2xl text-slate-900"></i>
    </button>



    <script type="module">
        // These variables are now declared ONLY ONCE to fix the "Redeclare" error
        const chatWidget = document.getElementById('gemini-chat-widget');
        const chatToggle = document.getElementById('gemini-toggle');
        const chatSendBtn = document.getElementById('gemini-send');
        const chatInputField = document.getElementById('gemini-input');
        const chatMessagesBox = document.getElementById('gemini-messages');

        let chatIsOpen = false;

        chatToggle.addEventListener('click', () => {
            chatIsOpen = !chatIsOpen;
            chatWidget.style.display = chatIsOpen ? 'flex' : 'none';
            if (chatIsOpen) chatInputField.focus();
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (chatIsOpen && !chatWidget.contains(e.target) && !chatToggle.contains(e.target)) {
                chatIsOpen = false;
                chatWidget.style.display = 'none';
            }
        });

        async function handleSendMessage() {
            const text = chatInputField.value.trim();
            if (!text) return;

            const userMsg = document.createElement('div');
            userMsg.className = 'gemini-message user';
            userMsg.textContent = text;
            chatMessagesBox.appendChild(userMsg);

            chatInputField.value = '';
            chatSendBtn.disabled = true;

            const aiMsg = document.createElement('div');
            aiMsg.className = 'gemini-message assistant';
            chatMessagesBox.appendChild(aiMsg);

            const typing = document.createElement('div');
            typing.className = 'gemini-typing';
            typing.innerHTML = '<span></span><span></span><span></span>';
            aiMsg.appendChild(typing);

            chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;

            try {
                let isFirstChunk = true;
                // Calls the Streaming Brain defined in the <head>
                await window.geminiAI.sendMessage(text, (chunkText) => {
                    if (isFirstChunk) {
                        typing.remove();
                        isFirstChunk = false;
                    }
                    aiMsg.textContent += chunkText;
                    chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;
                });
            } catch (error) {
                if (typing) typing.remove();
                aiMsg.textContent = '❌ Connection Error. Please check your API key.';
            }
            chatSendBtn.disabled = false;
        }

        chatSendBtn.onclick = handleSendMessage;
        chatInputField.onkeypress = (e) => { if (e.key === 'Enter') handleSendMessage(); };
    </script>
</body>


</html>